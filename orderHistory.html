<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <title>MerKato Pro — Order history</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#2b59ff">
    <link rel="manifest" href="manifest.webmanifest">
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
        crossorigin="anonymous"
    >
    <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    >
    <style>
        body {
            min-height: 100vh;
            background: radial-gradient(circle at top, #f5f7ff, #eef1ff 45%, #e6ecff 100%);
        }

        .topbar {
            background: rgba(255, 255, 255, 0.95);
            border-bottom: 1px solid rgba(15, 32, 98, 0.08);
        }

        .summary-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 1.25rem;
            padding: 1.5rem;
            border: 1px solid rgba(15, 32, 98, 0.08);
            box-shadow: 0 18px 40px -32px rgba(17, 45, 115, 0.45);
        }

        .stat-card {
            border: 1px dashed rgba(43, 89, 255, 0.3);
            border-radius: 1rem;
            padding: 1rem;
            background: rgba(43, 89, 255, 0.04);
        }

        .order-card {
            cursor: pointer;
        }

        .order-card.active {
            background: rgba(43, 89, 255, 0.08);
            border-left: 4px solid #2b59ff;
        }

        .order-items-list img {
            width: 56px;
            height: 56px;
            object-fit: cover;
            border-radius: 0.6rem;
        }

        .empty-state {
            text-align: center;
            padding: 2rem;
            color: #6b7498;
        }
    </style>
</head>
<body>
<header class="topbar py-3">
    <div class="container d-flex flex-wrap justify-content-between align-items-center gap-3">
        <div>
            <div class="text-uppercase text-muted small mb-1">MerKato Pro</div>
            <h1 class="h4 mb-0">Order history</h1>
        </div>
        <div class="d-flex gap-2">
            <a href="index.html" class="btn btn-outline-secondary"><i class="bi bi-arrow-left me-2"></i>Back to dashboard</a>
        </div>
    </div>
</header>

<main class="container py-4">
    <section class="summary-card mb-4">
        <div class="d-flex flex-column flex-lg-row justify-content-between gap-3 mb-3">
            <div>
                <h2 class="h5 fw-bold mb-1">Track your recent orders</h2>
                <p class="text-muted mb-0">Review order totals, statuses, and outstanding balances.</p>
            </div>
            <div class="d-flex gap-2 align-items-start">
                <div>
                    <div class="text-muted small">Outstanding cash</div>
                    <div class="h5 mb-0" id="unpaidCash">ETB 0.00</div>
                </div>
                <div>
                    <div class="text-muted small">Outstanding credit</div>
                    <div class="h5 mb-0" id="unpaidCredit">ETB 0.00</div>
                </div>
            </div>
        </div>
        <div class="row g-3" id="paymentAccounts">
            <div class="col-sm-6 col-lg-3">
                <div class="stat-card">
                    <div class="text-muted small">CBE account</div>
                    <div class="fw-semibold" id="cbeAccount">—</div>
                </div>
            </div>
            <div class="col-sm-6 col-lg-3">
                <div class="stat-card">
                    <div class="text-muted small">BOA account</div>
                    <div class="fw-semibold" id="boaAccount">—</div>
                </div>
            </div>
        </div>
    </section>

    <div class="row g-4">
        <div class="col-lg-5">
            <div class="card shadow-sm h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="h6 mb-0">Orders</h3>
                        <small class="text-muted">Latest first</small>
                    </div>
                    <button class="btn btn-sm btn-outline-primary" id="refreshOrdersBtn">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
                <div class="list-group list-group-flush" id="ordersList">
                    <div class="empty-state mb-0">
                        <div class="spinner-border text-primary" role="status" aria-hidden="true"></div>
                        <p class="mt-2 mb-0">Loading orders…</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-7">
            <div class="card shadow-sm h-100">
                <div class="card-header">
                    <h3 class="h6 mb-0">Order details</h3>
                </div>
                <div class="card-body" id="orderDetailPanel">
                    <div class="empty-state">
                        <i class="bi bi-clipboard-data fs-4 d-block mb-2"></i>
                        <p class="mb-0">Select an order to see its items.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"
></script>
<script src="pwa.js"></script>
<script>
    (function () {
        const sessionKey = 'mproSession';
        const API = {
            orders: 'api/order/getHistory.php',
            orderDetail: 'api/order/getorderListHistory.php'
        };

        const elements = {
            ordersList: document.getElementById('ordersList'),
            orderDetailPanel: document.getElementById('orderDetailPanel'),
            unpaidCash: document.getElementById('unpaidCash'),
            unpaidCredit: document.getElementById('unpaidCredit'),
            cbeAccount: document.getElementById('cbeAccount'),
            boaAccount: document.getElementById('boaAccount'),
            refreshOrdersBtn: document.getElementById('refreshOrdersBtn')
        };

        const state = {
            session: null,
            orders: [],
            selectedOrderId: null
        };

        function getSession() {
            try {
                const raw = localStorage.getItem(sessionKey);
                if (!raw) return null;
                const parsed = JSON.parse(raw);
                if (parsed && typeof parsed.customerId === 'number' && parsed.customerId > 0) {
                    return parsed;
                }
            } catch (err) {
                console.error('Failed to parse session', err);
            }
            return null;
        }

        function ensureSessionOrRedirect() {
            const session = getSession();
            if (!session) {
                sessionStorage.setItem('mproRedirect', 'orderHistory.html');
                window.location.href = 'login.html';
                return null;
            }
            return session;
        }

        function formatCurrency(value) {
            const amount = Number(value) || 0;
            return `ETB ${amount.toLocaleString(undefined, { minimumFractionDigits: 2 })}`;
        }

        function formatDate(value) {
            if (!value) return 'Unknown date';
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) return value;
            return date.toLocaleString();
        }

        function statusLabel(code) {
            const map = {
                1: 'Pending',
                2: 'Processing',
                3: 'Dispatched',
                4: 'Delivered',
                5: 'Completed',
                6: 'Closed'
            };
            return map[code] || `Status ${code ?? 'N/A'}`;
        }

        function fetchJson(url, options) {
            return fetch(url, options).then(async (response) => {
                const payload = await response.json().catch(() => ({}));
                if (!response.ok) {
                    throw new Error(payload.message || `Request failed with status ${response.status}`);
                }
                return payload;
            });
        }

        async function loadOrders() {
            elements.ordersList.innerHTML = `
                <div class="empty-state mb-0">
                    <div class="spinner-border text-primary" role="status" aria-hidden="true"></div>
                    <p class="mt-2 mb-0">Loading orders…</p>
                </div>
            `;
            const payload = await fetchJson(API.orders, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ customerId: state.session.customerId })
            });

            state.orders = Array.isArray(payload.orders) ? payload.orders : [];
            state.selectedOrderId = null;
            elements.unpaidCash.textContent = formatCurrency(payload.totaUnpaidCash);
            elements.unpaidCredit.textContent = formatCurrency(payload.totalUnpaidCredit);
            elements.cbeAccount.textContent = payload.cbeAccount || '—';
            elements.boaAccount.textContent = payload.boaAccount || '—';

            renderOrders();
            elements.orderDetailPanel.innerHTML = `
                <div class="empty-state">
                    <i class="bi bi-clipboard-data fs-4 d-block mb-2"></i>
                    <p class="mb-0">Select an order to see its items.</p>
                </div>
            `;
        }

        function renderOrders() {
            if (state.orders.length === 0) {
                elements.ordersList.innerHTML = `
                    <div class="empty-state mb-0">
                        <i class="bi bi-inboxes fs-4 d-block mb-2"></i>
                        <p class="mb-0">No orders recorded yet.</p>
                    </div>
                `;
                return;
            }

            elements.ordersList.innerHTML = state.orders.map(order => {
                const isActive = Number(state.selectedOrderId) === Number(order.orderId);
                return `
                    <button class="list-group-item list-group-item-action order-card ${isActive ? 'active' : ''}" data-order-id="${order.orderId}">
                        <div class="d-flex justify-content-between">
                            <div>
                                <div class="fw-semibold">Order #${order.orderId}</div>
                                <div class="text-muted small">${formatDate(order.orderTime)}</div>
                                <div class="text-muted small">${statusLabel(order.deliverStatus)}</div>
                            </div>
                            <div class="text-end">
                                <div class="fw-semibold text-primary">${formatCurrency(order.totalPrice)}</div>
                            </div>
                        </div>
                    </button>
                `;
            }).join('');
        }

        async function loadOrderDetails(orderId) {
            state.selectedOrderId = orderId;
            renderOrders();
            elements.orderDetailPanel.innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status" aria-hidden="true"></div>
                    <p class="mt-2 mb-0 text-muted">Loading order details…</p>
                </div>
            `;

            try {
                const items = await fetchJson(API.orderDetail, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ orderId })
                });
                renderOrderDetails(items);
            } catch (error) {
                console.error('Failed to load order details', error);
                elements.orderDetailPanel.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-exclamation-triangle-fill text-warning fs-4 d-block mb-2"></i>
                        <p class="mb-0">${error.message || 'Unable to load order details.'}</p>
                    </div>
                `;
            }
        }

        function renderOrderDetails(items) {
            if (!Array.isArray(items) || items.length === 0) {
                elements.orderDetailPanel.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-folder-x fs-4 d-block mb-2"></i>
                        <p class="mb-0">No items recorded for this order.</p>
                    </div>
                `;
                return;
            }

            const total = items.reduce((sum, item) => sum + (Number(item.price) || 0) * (Number(item.quantity) || 0), 0);
            elements.orderDetailPanel.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <div class="text-muted small">Order total</div>
                        <div class="h5 text-primary mb-0">${formatCurrency(total)}</div>
                    </div>
                    <div class="text-muted small">Items: ${items.length}</div>
                </div>
                <div class="order-items-list d-flex flex-column gap-3">
                    ${items.map(item => `
                        <div class="d-flex gap-3 align-items-center border rounded-3 p-2">
                            <img src="${item.goodsImage || 'https://via.placeholder.com/80'}" alt="${item.goodsName}">
                            <div class="flex-grow-1">
                                <div class="fw-semibold">${item.goodsName || 'Goods'}</div>
                                <div class="text-muted small">${item.supplierName || ''}</div>
                            </div>
                            <div class="text-end">
                                <div class="fw-semibold">${formatCurrency(item.price)}</div>
                                <small class="text-muted">Qty: ${item.quantity}</small>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function attachEventListeners() {
            elements.ordersList.addEventListener('click', (event) => {
                const button = event.target.closest('.order-card');
                if (!button) return;
                const orderId = Number(button.dataset.orderId);
                if (!orderId || orderId === state.selectedOrderId) return;
                loadOrderDetails(orderId);
            });

            elements.refreshOrdersBtn.addEventListener('click', () => {
                loadOrders().catch(err => console.error(err));
            });
        }

        async function init() {
            state.session = ensureSessionOrRedirect();
            if (!state.session) return;
            attachEventListeners();
            try {
                await loadOrders();
            } catch (error) {
                console.error('Failed to load history', error);
                elements.ordersList.innerHTML = `
                    <div class="empty-state mb-0">
                        <i class="bi bi-wifi-off fs-4 d-block mb-2"></i>
                        <p class="mb-0">${error.message || 'Unable to load orders.'}</p>
                    </div>
                `;
            }
        }

        init();
    })();
</script>
</body>
</html>
