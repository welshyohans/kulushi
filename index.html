<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <title>MerKato Pro — Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#2b59ff">
    <link rel="manifest" href="manifest.webmanifest">
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
        crossorigin="anonymous"
    >
    <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    >
    <style>
        :root {
            --primary-color: #2b59ff;
            --primary-variant: #1e3ec9;
            --surface-bg: #f5f7ff;
            --surface-gradient: radial-gradient(circle at top, #f3f6ff, #edf1ff 48%, #e7ecff 100%);
            --border-soft: rgba(43, 89, 255, 0.12);
        }

        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            min-height: 100vh;
            background: var(--surface-gradient);
            color: #1b2540;
            padding-bottom: 80px;
            overflow-x: hidden;
            max-width: 100vw;
        }

        main {
            padding-bottom: 2rem;
            overflow-x: hidden;
        }

        .page-shell {
            min-height: calc(100vh - 60px);
            overflow-x: hidden;
        }

        .topbar {
            background: rgba(255, 255, 255, 0.9);
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(15, 32, 98, 0.06);
            position: sticky;
            top: 0;
            z-index: 1030;
        }

        .topbar .brand {
            font-weight: 700;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            color: var(--primary-variant);
        }

        .android-banner {
            display: none;
            background: var(--primary-color);
            color: #fff;
            padding: 0.85rem 1.2rem;
            border-radius: 0.85rem;
            margin-bottom: 0.85rem;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
            box-shadow: 0 18px 48px -32px rgba(17, 45, 115, 0.6);
        }

        .android-banner a {
            background: rgba(255, 255, 255, 0.14);
            border-radius: 999px;
            padding: 0.45rem 1.15rem;
            color: #fff;
            text-decoration: none;
            font-weight: 600;
            letter-spacing: 0.04em;
        }

        .android-banner button {
            color: #fff;
            border: none;
            background: transparent;
        }

        .layout {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }

        .side-nav {
            position: sticky;
            top: 96px;
            align-self: start;
        }

        .side-nav .nav-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 0.85rem;
            font-weight: 600;
            color: #25315b;
            transition: all 0.2s ease;
        }

        .side-nav .nav-link.active {
            background: linear-gradient(135deg, rgba(43, 89, 255, 0.18), rgba(43, 89, 255, 0.05));
            color: var(--primary-variant);
        }

        .summary-card {
            background: rgba(255, 255, 255, 0.92);
            border-radius: 1.15rem;
            padding: 1.5rem;
            border: 1px solid var(--border-soft);
            box-shadow: 0 24px 48px -42px rgba(32, 48, 96, 0.55);
        }

        .home-screen {
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.95), rgba(248, 250, 255, 0.95));
            padding: 1.9rem;
        }

        .home-hero-card {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.2rem;
            padding: 1.5rem;
            border-radius: 1.1rem;
            background: linear-gradient(135deg, rgba(43, 89, 255, 0.12), rgba(255, 255, 255, 0.95));
            border: 1px solid rgba(43, 89, 255, 0.2);
            box-shadow: 0 25px 55px -40px rgba(15, 32, 90, 0.8);
        }

        .home-hero-kicker {
            letter-spacing: 0.2em;
            color: rgba(34, 55, 115, 0.8);
        }

        .home-hero-title {
            line-height: 1.3;
        }

        .home-hero-actions {
            align-self: center;
            justify-self: end;
        }

        .home-hero-badge {
            background: rgba(255, 255, 255, 0.85);
            border-radius: 0.75rem;
            padding: 0.4rem 0.85rem;
            box-shadow: inset 0 0 0 1px rgba(43, 89, 255, 0.25);
            color: var(--primary-variant);
            font-weight: 600;
        }

        .home-highlight-grid {
            margin-top: 1.25rem;
            display: grid;
            gap: 1rem;
            grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
        }

        .home-highlight-card {
            background: #fff;
            border-radius: 1rem;
            padding: 1rem 1.15rem;
            border: 1px solid rgba(18, 42, 94, 0.12);
            box-shadow: 0 18px 32px -22px rgba(15, 34, 85, 0.4);
            display: flex;
            flex-direction: column;
            gap: 0.15rem;
        }

        .home-highlight-card strong {
            font-size: 2.1rem;
            line-height: 1.2;
            font-weight: 700;
        }

        .home-highlight-card span {
            color: #5c667f;
        }

        .home-highlight-card.hi-goods strong {
            color: #0f3c94;
        }

        .home-highlight-card.hi-category strong {
            color: #0c9f6b;
        }

        .home-highlight-card.hi-cart strong {
            color: #d8576b;
        }

        .home-section-head {
            margin-top: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .home-section-head .badge {
            font-size: 0.85rem;
        }

        .home-section-head button {
            white-space: nowrap;
        }

        .goods-grid {
            display: grid;
            gap: 1rem;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            width: 100%;
            max-width: 100%;
        }

        .goods-card {
            border: 1px solid rgba(15, 32, 98, 0.08);
            border-radius: 1.25rem;
            overflow: hidden;
            background: linear-gradient(180deg, #fff, #f7f9ff);
            display: flex;
            flex-direction: column;
            min-height: 100%;
            box-shadow: 0 18px 45px -32px rgba(15, 34, 85, 0.55);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            min-width: 0;
        }

        .goods-card button {
            border: none;
            background: none;
            padding: 0;
            display: block;
            width: 100%;
        }

        .goods-card:hover {
            transform: translateY(-6px) scale(1.005);
            box-shadow: 0 28px 60px -40px rgba(15, 34, 85, 0.65);
        }

        .goods-card img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            background: linear-gradient(180deg, rgba(243, 246, 255, 0.7), rgba(220, 227, 255, 0.95));
        }

        .goods-card .card-body {
            display: flex;
            flex-direction: column;
            gap: 0.7rem;
            padding: 1rem 1.25rem 1.3rem;
            flex: 1;
        }

        .goods-card .supplier-chip {
            background: rgba(43, 89, 255, 0.08);
            color: var(--primary-variant);
            border-radius: 0.75rem;
            padding: 0.25rem 0.65rem;
            font-size: 0.85rem;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }

        .goods-card .price-tag {
            font-weight: 700;
            font-size: 1.2rem;
        }

        .goods-card .actions {
            display: flex;
            gap: 0.6rem;
            flex-wrap: wrap;
            margin-top: auto;
        }

        .goods-card .actions button {
            flex: 1 1 48%;
            min-width: 110px;
        }

        .goods-card .quantity-control {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(43, 89, 255, 0.08);
            border-radius: 0.8rem;
            padding: 0.25rem 0.5rem;
            gap: 0.5rem;
        }

        .goods-card .quantity-control button {
            border-radius: 999px;
            width: 38px;
            height: 38px;
            display: grid;
            place-items: center;
            font-size: 1.15rem;
        }

        .chip-scroll {
            overflow-x: auto;
            display: flex;
            gap: 0.65rem;
            padding-bottom: 0.35rem;
            margin-bottom: 1.1rem;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
        }

        .chip-scroll::-webkit-scrollbar {
            height: 4px;
        }

        .chip-scroll::-webkit-scrollbar-thumb {
            background: rgba(43, 89, 255, 0.3);
            border-radius: 2px;
        }

        .chip {
            border-radius: 999px;
            padding: 0.4rem 1rem;
            border: 1px solid rgba(43, 89, 255, 0.2);
            background: rgba(255, 255, 255, 0.85);
            color: #22305b;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
        }

        .chip.active {
            background: var(--primary-color);
            color: #fff;
            border-color: transparent;
        }

        .supplier-card {
            border: 1px solid rgba(15, 32, 90, 0.04);
            border-radius: 1rem;
            padding: 0.85rem 1rem;
            display: flex;
            gap: 0.85rem;
            align-items: center;
            background: #fff;
            cursor: pointer;
            transition: transform 0.15s ease, border-color 0.15s ease;
        }

        .supplier-card:hover {
            transform: translateY(-2px);
            border-color: rgba(43, 89, 255, 0.3);
        }

        .supplier-card.active {
            border-color: var(--primary-color);
            box-shadow: 0 20px 40px -30px rgba(43, 89, 255, 0.45);
        }

        .supplier-avatar {
            width: 48px;
            height: 48px;
            border-radius: 999px;
            background: rgba(43, 89, 255, 0.12);
            display: grid;
            place-items: center;
            font-size: 1.4rem;
            color: var(--primary-variant);
        }

        .mobile-bottom-nav {
            background: rgba(255, 255, 255, 0.96);
            border-top: 1px solid rgba(15, 32, 90, 0.1);
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1040;
            box-shadow: 0 -6px 24px -18px rgba(15, 32, 90, 0.4);
            max-width: 100vw;
            overflow: hidden;
        }

        .mobile-bottom-nav .nav-link {
            font-size: 0.8rem;
            color: #455078;
            padding: 0.5rem;
            flex: 1;
            min-width: 0;
        }

        .toast-container {
            z-index: 1080;
        }

        .modal-rounded .modal-content {
            border-radius: 1.2rem;
            border: none;
        }

        .modal-rounded .modal-header {
            border-bottom: none;
        }

        .modal-rounded .modal-footer {
            border-top: none;
        }

        .cart-item-card {
            border: 1px solid rgba(15, 32, 90, 0.08);
            border-radius: 0.95rem;
            padding: 0.85rem 1rem;
            display: flex;
            gap: 0.85rem;
            align-items: center;
            background: rgba(255, 255, 255, 0.96);
        }

        .cart-item-card img {
            width: 72px;
            height: 72px;
            object-fit: cover;
            border-radius: 0.75rem;
        }

        .cart-summary-card {
            border: 1px dashed rgba(43, 89, 255, 0.45);
            border-radius: 1rem;
            padding: 1rem 1.25rem;
            background: rgba(43, 89, 255, 0.08);
        }

        .options-list {
            display: grid;
            gap: 0.75rem;
        }

        .option-row {
            border: 1px solid rgba(15, 32, 90, 0.1);
            border-radius: 0.9rem;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.98);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            align-items: center;
            gap: 0.75rem;
        }

        .option-row button {
            justify-self: end;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #6b7498;
        }

        .profile-summary {
            border: 1px solid var(--border-soft);
            border-radius: 1rem;
            padding: 1.25rem;
            background: rgba(255, 255, 255, 0.92);
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .profile-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .register-friend-modal .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }

        .register-friend-modal .form-control:disabled {
            cursor: not-allowed;
        }

        .skeleton {
            display: inline-block;
            border-radius: 0.75rem;
            background-image: linear-gradient(90deg, rgba(200, 210, 240, 0.25), rgba(200, 210, 240, 0.45), rgba(200, 210, 240, 0.25));
            background-size: 200% 100%;
            animation: shimmer 1.2s ease-in-out infinite;
        }

        @keyframes shimmer {
            0% { background-position-x: -200%; }
            100% { background-position-x: 200%; }
        }

        @media (max-width: 991.98px) {
            .side-nav {
                display: none;
            }

            .topbar {
                padding-bottom: 0.5rem;
            }

            .home-hero-card {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            }

            .home-highlight-grid {
                grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            }

            .goods-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }

        @media (min-width: 992px) {
            body {
                padding-bottom: 0;
            }

            .layout {
                grid-template-columns: 280px minmax(0, 1fr);
            }

            .mobile-bottom-nav {
                display: none;
            }
        }

        @media (max-width: 767.98px) {
            body {
                padding-bottom: 90px;
            }

            .home-hero-card {
                grid-template-columns: 1fr;
            }

            .home-hero-actions {
                justify-self: flex-start;
                align-self: flex-start;
            }

            .home-highlight-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .goods-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
                gap: 0.65rem;
            }

            .goods-card {
                min-width: 0;
            }

            .goods-card img {
                height: 140px;
            }

            .goods-card .card-body {
                padding: 0.85rem 0.95rem 1rem;
            }

            .goods-card .actions {
                flex-direction: column;
            }

            .goods-card .actions button {
                width: 100%;
            }

            .goods-card .price-tag {
                font-size: 1rem;
            }
        }

        @media (min-width: 1200px) {
            .goods-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (min-width: 1600px) {
            .goods-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
    </style>
</head>
<body>
<header class="topbar shadow-sm">
    <div class="container py-3">
        <div id="androidBanner" class="android-banner">
            <div class="d-flex align-items-center gap-2">
                <i class="bi bi-android2 fs-4"></i>
                <span class="fw-semibold">Download MerKato Pro App for the fastest wholesale ordering.</span>
            </div>
            <div class="d-flex align-items-center gap-2">
                <a href="app/merkatopro.apk" id="androidBannerCta" download>Download App</a>
                <button type="button" class="btn-close btn-close-white" id="dismissAndroidBanner" aria-label="Dismiss banner"></button>
            </div>
        </div>

        <div class="d-flex flex-wrap align-items-center gap-3">
            <div class="d-flex align-items-center gap-3 order-1 flex-grow-1 flex-lg-grow-0">
                <span class="brand">Merkato Pro</span>
                <span class="badge text-bg-light d-none d-lg-inline-flex">
                    <i class="bi bi-person-check me-1"></i>
                    <span id="customerNameBadge">Loading…</span>
                </span>
            </div>
            <div class="flex-grow-1 order-2 w-100 w-lg-auto">
                <div class="input-group">
                    <span class="input-group-text bg-transparent border-end-0">
                        <i class="bi bi-search"></i>
                    </span>
                    <input type="search" class="form-control border-start-0" placeholder="Search goods…" id="globalSearchInput" aria-label="Search goods">
                </div>
            </div>
            <div class="d-none d-lg-flex align-items-center gap-3 order-3 ms-lg-auto">
                <button class="btn btn-outline-primary position-relative" id="cartBtn" data-bs-toggle="modal" data-bs-target="#cartModal">
                    <i class="bi bi-cart3 me-2"></i>
                    Cart
                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="cartCountBadge">0</span>
                </button>
            </div>
            <div class="d-flex d-lg-none align-items-center gap-3 ms-auto order-4">
                <button class="btn btn-outline-primary position-relative" id="cartBtnMobile" data-bs-toggle="modal" data-bs-target="#cartModal" aria-label="Open cart">
                    <i class="bi bi-cart3 fs-5"></i>
                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="cartCountBadgeMobile">0</span>
                </button>
            </div>
        </div>
    </div>
</header>

<main class="container py-4 page-shell">
    <div class="layout">
        <nav class="side-nav d-none d-lg-flex flex-column gap-1">
            <button class="nav-link active" data-screen-target="homeScreen">
                <i class="bi bi-house-door-fill"></i>
                Home
            </button>
            <button class="nav-link" data-screen-target="categoriesScreen">
                <i class="bi bi-grid-3x3-gap-fill"></i>
                Categories
            </button>
            <button class="nav-link" data-screen-target="suppliersScreen">
                <i class="bi bi-shop-window"></i>
                Suppliers
            </button>
            <button class="nav-link" data-screen-target="profileScreen">
                <i class="bi bi-person-bounding-box"></i>
                Profile
            </button>
        </nav>

        <section class="content-stack d-flex flex-column gap-4">
            <section id="homeScreen" class="summary-card home-screen">
                <div class="home-hero-card">
                    <div>
                        <p class="home-hero-kicker text-uppercase small mb-2">Curated wholesale</p>
                        <h1 class="h3 fw-bold home-hero-title mb-2">Fresh goods for your shop</h1>
                        <p class="text-muted mb-0">Browse trusted supplier picks, compare live prices, and keep your shelves stocked from one tap.</p>
                    </div>
                    <div class="d-flex flex-column gap-2 home-hero-actions">
                        <span class="badge home-hero-badge align-self-start">
                            <i class="bi bi-phone me-1"></i>
                            <span id="homeSuppliersStat">0</span> suppliers online
                        </span>
                        <a href="app/merkatopro.apk" class="btn btn-outline-primary btn-sm w-auto" download>
                            <i class="bi bi-cloud-download me-1"></i>
                            Get the Android app
                        </a>
                    </div>
                </div>

                <div class="home-highlight-grid">
                    <article class="home-highlight-card hi-goods">
                        <small class="text-uppercase text-muted">Live shortlist</small>
                        <strong id="homeGoodsStat">0</strong>
                        <span class="text-muted small">Goods ready to order</span>
                    </article>
                    <article class="home-highlight-card hi-category">
                        <small class="text-uppercase text-muted">Active categories</small>
                        <strong id="homeCategoriesStat">0</strong>
                        <span class="text-muted small">Fresh assortments daily</span>
                    </article>
                    <article class="home-highlight-card hi-cart">
                        <small class="text-uppercase text-muted">Cart items</small>
                        <strong id="homeCartStat">0</strong>
                        <span class="text-muted small">Waiting for checkout</span>
                    </article>
                </div>

                <div class="home-section-head">
                    <div>
                        <h2 class="h4 fw-bold mb-1">Featured goods</h2>
                        <p class="text-muted mb-0">Top picks prioritized by demand and supplier prices.</p>
                    </div>
                    <div class="d-flex flex-wrap align-items-center gap-2">
                        <span class="badge text-bg-light">
                            <i class="bi bi-box-seam me-1"></i>
                            <span id="featuredGoodsCount">0</span> items
                        </span>
                        <button class="btn btn-outline-secondary btn-sm" id="reloadFeaturedBtn">
                            <i class="bi bi-arrow-clockwise me-1"></i>
                            Refresh
                        </button>
                    </div>
                </div>

                <div class="chip-scroll" id="homeCategoryChips" aria-label="Category quick filters"></div>
                <div class="goods-grid" id="goodsGrid" aria-live="polite"></div>

                <div class="text-center mt-4">
                    <button class="btn btn-outline-primary px-4" id="loadMoreGoodsBtn">
                        <i class="bi bi-arrow-down-circle me-2"></i>
                        Load more goods
                    </button>
                </div>
            </section>

            <section id="categoriesScreen" class="summary-card d-none">
                <header class="d-flex flex-column flex-md-row justify-content-between gap-3 mb-3">
                    <div>
                        <h2 class="h4 fw-bold mb-1">Browse by category</h2>
                        <p class="text-muted mb-0">Tap any category to explore goods stocked for your shop.</p>
                    </div>
                    <span class="badge text-bg-light align-self-start">
                        <i class="bi bi-collection me-1"></i>
                        <span id="categoryCountBadge">0</span> categories
                    </span>
                </header>
                <div class="row g-3" id="categoryCardList"></div>
            </section>

            <section id="suppliersScreen" class="summary-card d-none">
                <header class="d-flex flex-column flex-md-row justify-content-between gap-3 mb-4">
                    <div>
                        <h2 class="h4 fw-bold mb-1">Suppliers</h2>
                        <p class="text-muted mb-0">Explore suppliers to see their best performing goods.</p>
                    </div>
                    <div class="input-group input-group-sm w-auto">
                        <span class="input-group-text bg-transparent border-end-0">
                            <i class="bi bi-search"></i>
                        </span>
                        <input type="search" class="form-control border-start-0" id="supplierSearchInput" placeholder="Search suppliers">
                    </div>
                </header>
                <div class="row g-3" id="supplierList"></div>
            </section>

            <section id="profileScreen" class="summary-card d-none">
                <header class="d-flex align-items-center justify-content-between mb-4">
                    <div>
                        <h2 class="h4 fw-bold mb-1">Your profile</h2>
                        <p class="text-muted mb-0">Keep your shop information up to date for accurate deliveries.</p>
                    </div>
                    <button class="btn btn-outline-danger" id="logoutBtn">
                        <i class="bi bi-box-arrow-right me-2"></i>
                        Logout
                    </button>
                </header>

                <div class="profile-summary mb-4">
                    <div>
                        <div class="text-uppercase text-muted small">Signed in as</div>
                        <div class="h5 fw-bold mb-1" id="profileSummaryName">Loading…</div>
                        <div class="text-muted mb-1" id="profileSummaryShop">—</div>
                        <div class="fw-semibold" id="profileSummaryPhone">—</div>
                    </div>
                    <div class="profile-actions">
                        <button class="btn btn-primary flex-grow-1" id="registerFriendBtn">
                            <i class="bi bi-person-plus-fill me-2"></i>
                            Register your friend
                        </button>
                        <button class="btn btn-outline-primary flex-grow-1" id="orderHistoryBtn">
                            <i class="bi bi-clock-history me-2"></i>
                            Order history
                        </button>
                    </div>
                </div>

                <div class="row g-3" id="profileInfoGrid"></div>
            </section>
        </section>
    </div>
</main>

<nav class="mobile-bottom-nav border-top d-lg-none">
    <div class="container">
        <div class="nav d-flex justify-content-around text-center py-2">
            <button class="nav-link active" data-screen-target="homeScreen">
                <i class="bi bi-house-door-fill d-block fs-5"></i>
                Home
            </button>
            <button class="nav-link" data-screen-target="categoriesScreen">
                <i class="bi bi-grid-3x3-gap-fill d-block fs-5"></i>
                Category
            </button>
            <button class="nav-link" data-screen-target="suppliersScreen">
                <i class="bi bi-shop-window d-block fs-5"></i>
                Suppliers
            </button>
            <button class="nav-link" data-screen-target="profileScreen">
                <i class="bi bi-person-bounding-box d-block fs-5"></i>
                Profile
            </button>
        </div>
    </div>
</nav>

<!-- Cart Modal -->
<div class="modal modal-rounded fade" id="cartModal" tabindex="-1" aria-labelledby="cartModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title fs-5 text-primary" id="cartModalLabel">
                    <i class="bi bi-cart3 me-2"></i>
                    Your cart
                </h2>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close cart"></button>
            </div>
            <div class="modal-body">
                <div id="cartItemsContainer" class="d-flex flex-column gap-3"></div>
                <div class="cart-summary-card mt-4" id="cartSummaryCard">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="fw-semibold text-muted">Items</span>
                        <span class="fw-semibold" id="cartSummaryItems">0</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="fw-semibold text-muted">Total quantity</span>
                        <span class="fw-semibold" id="cartSummaryQuantity">0</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="fw-semibold text-muted">Total amount</span>
                        <span class="fw-bold fs-5 text-primary" id="cartSummaryAmount">ETB 0.00</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer d-flex justify-content-between">
                <button class="btn btn-outline-secondary" id="clearCartBtn">
                    <i class="bi bi-trash3 me-2"></i>
                    Clear cart
                </button>
                <button class="btn btn-primary" id="placeOrderBtn">
                    <i class="bi bi-bag-check me-2"></i>
                    Place order
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Options Modal -->
<div class="modal modal-rounded fade" id="optionsModal" tabindex="-1" aria-labelledby="optionsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title fs-5 text-primary" id="optionsModalLabel">Supplier options</h2>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close options"></button>
            </div>
            <div class="modal-body">
                <div class="options-list" id="optionsList"></div>
            </div>
        </div>
    </div>
</div>

<!-- Register friend Modal -->
<div class="modal fade modal-rounded register-friend-modal" id="registerFriendModal" tabindex="-1" aria-labelledby="registerFriendModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form id="registerFriendForm" novalidate>
                <div class="modal-header">
                    <h2 class="modal-title fs-5 text-primary" id="registerFriendModalLabel">
                        <i class="bi bi-person-plus-fill me-2"></i>
                        Register your friend
                    </h2>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="registerFriendFeedback" class="alert d-none" role="alert"></div>
                    <div class="mb-3">
                        <label class="form-label" for="friendNameInput">Friend name</label>
                        <input type="text" class="form-control" id="friendNameInput" name="name" placeholder="Enter full name" required>
                        <div class="invalid-feedback">Name is required.</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="friendShopInput">Shop name</label>
                        <input type="text" class="form-control" id="friendShopInput" name="shopName" placeholder="e.g. Abeba Mini" required>
                        <div class="invalid-feedback">Shop name is required.</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="friendPhoneInput">Phone number</label>
                        <input type="tel" class="form-control" id="friendPhoneInput" name="phone" placeholder="09xxxxxxxx" required>
                        <div class="invalid-feedback">Enter a valid phone number.</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="friendAddressSelect">Delivery address</label>
                        <select class="form-select" id="friendAddressSelect" name="addressId" required disabled>
                            <option value="">Loading addresses…</option>
                        </select>
                        <div class="invalid-feedback">Select an address.</div>
                    </div>
                    <p class="text-muted small mb-0">
                        We'll create a 4-digit password automatically and send it to your friend's phone once registered.
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-link text-muted" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="registerFriendSubmitBtn">
                        <span class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true" id="registerFriendSpinner"></span>
                        Submit registration
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Goods Detail Modal -->
<div class="modal modal-rounded fade" id="goodsDetailModal" tabindex="-1" aria-labelledby="goodsDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title fs-5 text-primary" id="goodsDetailModalLabel">Goods details</h2>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close details"></button>
            </div>
            <div class="modal-body">
                <div class="row g-4 align-items-start">
                    <div class="col-md-5">
                        <div class="ratio ratio-1x1 rounded-3 overflow-hidden border">
                            <img id="detailImage" src="" alt="Goods preview" class="w-100 h-100 object-fit-cover" loading="lazy">
                        </div>
                    </div>
                    <div class="col-md-7 d-flex flex-column gap-3">
                        <div>
                            <h3 class="h4 fw-bold" id="detailName"></h3>
                            <span class="badge text-bg-light" id="detailCategory">Category</span>
                        </div>
                        <div class="d-flex align-items-center gap-3">
                            <span class="text-primary fw-bold fs-5" id="detailPrice">ETB 0.00</span>
                            <span class="supplier-chip" id="detailSupplier">
                                <i class="bi bi-shop"></i>
                                Supplier
                            </span>
                        </div>
                        <div>
                            <h4 class="h6 text-muted text-uppercase mb-2">Description</h4>
                            <div class="text-muted" id="detailDescription" style="max-height: 180px; overflow-y: auto;"></div>
                        </div>
                        <div>
                            <h4 class="h6 text-muted text-uppercase mb-2">Comments</h4>
                            <div class="border rounded-3 p-3" style="max-height: 220px; overflow-y: auto;" id="detailComments">
                                <div class="text-center text-muted small">Loading comments…</div>
                            </div>
                        </div>
                        <button class="btn btn-primary" id="detailAddToCartBtn" data-goods-id="">
                            <i class="bi bi-cart-plus me-2"></i>
                            Add to cart
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Android reminder modal -->
<div class="modal fade modal-rounded" id="androidDownloadModal" tabindex="-1" aria-labelledby="androidDownloadModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0">
            <div class="modal-header">
                <h2 class="modal-title fs-5 text-primary" id="androidDownloadModalLabel">
                    <i class="bi bi-android2 me-2"></i>
                    Install Merkato Pro App
                </h2>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close reminder"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-0">
                    Enjoy instant supplier updates, offline catalogues, and background order tracking with the Android app.
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Later</button>
                <a href="app/merkatopro.apk" class="btn btn-primary" download>
                    <i class="bi bi-download me-2"></i>
                    Download
                </a>
            </div>
        </div>
    </div>
</div>

<div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer"></div>

<script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"
></script>
<script src="pwa.js"></script>
<script type="module">
    const sessionKey = 'mproSession';
    const cartKey = 'mproCartItems';
    const androidBannerKey = 'mproAndroidBannerDismissed';
    const androidModalKey = 'mproAndroidModalDismissed';

    const API = {
        featuredGoods: 'api/dashboard/getFeaturedGoods.php',
        goodsByCategory: (categoryId, offset = 0, limit = 20) => `api/dashboard/getGoodsByCategory.php?categoryId=${encodeURIComponent(categoryId)}&offset=${offset}&limit=${limit}`,
        goodsBySupplier: (supplierId) => `api/dashboard/getGoodsBySupplier.php?supplierId=${encodeURIComponent(supplierId)}`,
        supplierOptions: (goodsId) => `api/dashboard/getSupplierGoodsOptions.php?goodsId=${encodeURIComponent(goodsId)}`,
        categories: 'api/dashboard/getCategories.php',
        suppliers: 'api/dashboard/getSuppliers.php',
        profile: 'api/customer/profile.php',
        comments: 'api/comment/getComments.php',
        orderFromCart: 'api/order/createFromCart.php',
        registerFriend: 'api/customer/registerYourFriend.php',
        addresses: 'api/address/getAllAddress.php'
    };

    const elements = {
        androidBanner: document.getElementById('androidBanner'),
        dismissAndroidBanner: document.getElementById('dismissAndroidBanner'),
        globalSearchInput: document.getElementById('globalSearchInput'),
        goodsGrid: document.getElementById('goodsGrid'),
        featuredGoodsCount: document.getElementById('featuredGoodsCount'),
        reloadFeaturedBtn: document.getElementById('reloadFeaturedBtn'),
        loadMoreGoodsBtn: document.getElementById('loadMoreGoodsBtn'),
        homeCategoryChips: document.getElementById('homeCategoryChips'),
        homeGoodsStat: document.getElementById('homeGoodsStat'),
        homeSuppliersStat: document.getElementById('homeSuppliersStat'),
        homeCategoriesStat: document.getElementById('homeCategoriesStat'),
        homeCartStat: document.getElementById('homeCartStat'),
        categoryCardList: document.getElementById('categoryCardList'),
        categoryCountBadge: document.getElementById('categoryCountBadge'),
        supplierList: document.getElementById('supplierList'),
        supplierSearchInput: document.getElementById('supplierSearchInput'),
        profileInfoGrid: document.getElementById('profileInfoGrid'),
        customerNameBadge: document.getElementById('customerNameBadge'),
        profileSummaryName: document.getElementById('profileSummaryName'),
        profileSummaryPhone: document.getElementById('profileSummaryPhone'),
        profileSummaryShop: document.getElementById('profileSummaryShop'),
        cartItemsContainer: document.getElementById('cartItemsContainer'),
        cartSummaryItems: document.getElementById('cartSummaryItems'),
        cartSummaryQuantity: document.getElementById('cartSummaryQuantity'),
        cartSummaryAmount: document.getElementById('cartSummaryAmount'),
        cartCountBadge: document.getElementById('cartCountBadge'),
        cartCountBadgeMobile: document.getElementById('cartCountBadgeMobile'),
        clearCartBtn: document.getElementById('clearCartBtn'),
        placeOrderBtn: document.getElementById('placeOrderBtn'),
        toastContainer: document.getElementById('toastContainer'),
        navButtons: document.querySelectorAll('[data-screen-target]'),
        screens: {
            homeScreen: document.getElementById('homeScreen'),
            categoriesScreen: document.getElementById('categoriesScreen'),
            suppliersScreen: document.getElementById('suppliersScreen'),
            profileScreen: document.getElementById('profileScreen')
        },
        logoutBtn: document.getElementById('logoutBtn'),
        detailModal: document.getElementById('goodsDetailModal'),
        detailImage: document.getElementById('detailImage'),
        detailName: document.getElementById('detailName'),
        detailCategory: document.getElementById('detailCategory'),
        detailPrice: document.getElementById('detailPrice'),
        detailSupplier: document.getElementById('detailSupplier'),
        detailDescription: document.getElementById('detailDescription'),
        detailComments: document.getElementById('detailComments'),
        detailAddToCartBtn: document.getElementById('detailAddToCartBtn'),
        optionsList: document.getElementById('optionsList'),
        optionsModalLabel: document.getElementById('optionsModalLabel'),
        androidDownloadModal: document.getElementById('androidDownloadModal'),
        registerFriendBtn: document.getElementById('registerFriendBtn'),
        orderHistoryBtn: document.getElementById('orderHistoryBtn'),
        registerFriendModal: document.getElementById('registerFriendModal'),
        registerFriendForm: document.getElementById('registerFriendForm'),
        registerFriendFeedback: document.getElementById('registerFriendFeedback'),
        friendAddressSelect: document.getElementById('friendAddressSelect'),
        registerFriendSubmitBtn: document.getElementById('registerFriendSubmitBtn'),
        registerFriendSpinner: document.getElementById('registerFriendSpinner')
    };

    const loadMoreDefaultLabel = elements.loadMoreGoodsBtn?.innerHTML || '';

    const state = {
        session: null,
        goods: [],
        filteredGoods: [],
        categories: [],
        suppliers: [],
        profile: null,
        addresses: [],
        pagination: {
            limit: 20,
            offsets: {
                home: 0,
                category: 0,
                supplier: 0
            },
            hasMore: {
                home: true,
                category: true,
                supplier: false
            },
            context: 'home',
            contextId: null
        },
        activeCategoryId: null,
        activeSupplierId: null,
        searchQuery: '',
        cart: loadCart(),
        isLoadingGoods: false
    };

    let optionsModalInstance = bootstrap.Modal.getOrCreateInstance(document.getElementById('optionsModal'));
    let detailModalInstance = bootstrap.Modal.getOrCreateInstance(elements.detailModal);
    let registerFriendModalInstance = bootstrap.Modal.getOrCreateInstance(elements.registerFriendModal);
    let androidModalInstance = null;

    function sessionOrRedirect() {
        try {
            const raw = localStorage.getItem(sessionKey);
            if (!raw) {
                window.location.href = 'login.html';
                return null;
            }
            const parsed = JSON.parse(raw);
            if (!parsed || typeof parsed.customerId !== 'number' || parsed.customerId <= 0) {
                localStorage.removeItem(sessionKey);
                window.location.href = 'login.html';
                return null;
            }
            return parsed;
        } catch (err) {
            console.error('Failed to parse session, redirecting', err);
            localStorage.removeItem(sessionKey);
            window.location.href = 'login.html';
            return null;
        }
    }

    function loadCart() {
        try {
            const raw = localStorage.getItem(cartKey);
            if (!raw) return [];
            const parsed = JSON.parse(raw);
            if (!Array.isArray(parsed)) return [];
            return parsed.filter(item => typeof item === 'object' && item !== null);
        } catch (err) {
            console.warn('Failed to parse cart, resetting', err);
            return [];
        }
    }

    function persistCart() {
        localStorage.setItem(cartKey, JSON.stringify(state.cart));
        renderCartCounter();
    }

    function getCartItemUnitPrice(item) {
        const base = Number(item?.basePrice ?? item?.price ?? 0);
        const commission = Number(item?.commission ?? 0);
        return base + commission;
    }

    function isAndroid() {
        return /Android/i.test(navigator.userAgent || '');
    }

    function dismissAndroidBanner() {
        elements.androidBanner.style.display = 'none';
        localStorage.setItem(androidBannerKey, '1');
    }

    function showAndroidBannerIfNeeded() {
        if (!isAndroid()) return;
        if (localStorage.getItem(androidBannerKey)) return;
        elements.androidBanner.style.display = 'flex';
    }

    function showAndroidModalIfNeeded() {
        if (!isAndroid()) return;
        if (localStorage.getItem(androidModalKey)) return;
        androidModalInstance = bootstrap.Modal.getOrCreateInstance(elements.androidDownloadModal, { backdrop: 'static' });
        setTimeout(() => androidModalInstance.show(), 1200);
    }

    function handleAndroidModalHidden() {
        localStorage.setItem(androidModalKey, '1');
    }

    function fetchJson(url, options = {}) {
        return fetch(url, options).then(async (response) => {
            if (!response.ok) {
                const payload = await response.json().catch(() => ({}));
                throw new Error(payload.message || `Request failed with status ${response.status}`);
            }
            return response.json();
        });
    }

    async function fetchProfile() {
        const payload = await fetchJson(API.profile, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ customerId: state.session.customerId })
        });
        if (!payload.success || !payload.profile) {
            throw new Error(payload.message || 'Profile not available');
        }
        state.profile = payload.profile;
        renderProfile();
        elements.customerNameBadge.textContent = payload.profile.name || 'Retailer';
    }

    function renderProfile() {
        if (!state.profile) return;
        const profile = state.profile;
        elements.profileSummaryName.textContent = profile.name || 'Retailer';
        elements.profileSummaryPhone.textContent = profile.phone || '—';
        elements.profileSummaryShop.textContent = profile.shopName ? `${profile.shopName}` : '—';
        elements.profileInfoGrid.innerHTML = `
            <div class="col-12 col-lg-6">
                <div class="border rounded-4 p-3 bg-white">
                    <h3 class="h6 text-muted text-uppercase mb-2">Account</h3>
                    <p class="mb-1"><strong>Name:</strong> ${profile.name || '—'}</p>
                    <p class="mb-1"><strong>Phone:</strong> ${profile.phone || '—'}</p>
                    <p class="mb-1"><strong>Shop name:</strong> ${profile.shopName || '—'}</p>
                </div>
            </div>
            <div class="col-12 col-lg-6">
                <div class="border rounded-4 p-3 bg-white">
                    <h3 class="h6 text-muted text-uppercase mb-2">Location</h3>
                    <p class="mb-1"><strong>City:</strong> ${profile.address?.city || '—'}</p>
                    <p class="mb-1"><strong>Area:</strong> ${profile.address?.subCity || '—'}</p>
                    <p class="mb-1"><strong>Specific:</strong> ${profile.specificAddress || '—'}</p>
                </div>
            </div>
            <div class="col-12">
                <div class="border rounded-4 p-3 bg-white">
                    <h3 class="h6 text-muted text-uppercase mb-2">Delivery info</h3>
                    <p class="mb-0 text-muted">${profile.deliveryInfo || 'Delivery details will appear here.'}</p>
                </div>
            </div>
        `;
    }

    async function loadAddressesIfNeeded() {
        if (state.addresses.length > 0) {
            return;
        }
        const payload = await fetchJson(API.addresses);
        if (Array.isArray(payload)) {
            state.addresses = payload;
        } else if (Array.isArray(payload.addresses)) {
            state.addresses = payload.addresses;
        } else {
            state.addresses = [];
        }
    }

    function renderAddressOptions() {
        if (!elements.friendAddressSelect) return;
        if (state.addresses.length === 0) {
            elements.friendAddressSelect.innerHTML = '<option value="">No addresses available</option>';
            elements.friendAddressSelect.disabled = true;
            return;
        }
        const options = ['<option value="">Select address</option>'].concat(
            state.addresses.map(address => `<option value="${address.addressId ?? address.id}">${address.addressName ?? address.name ?? 'Address'}</option>`)
        );
        elements.friendAddressSelect.innerHTML = options.join('');
        elements.friendAddressSelect.disabled = false;
    }

    function resetRegisterFriendForm() {
        if (!elements.registerFriendForm) return;
        elements.registerFriendForm.reset();
        elements.registerFriendForm.classList.remove('was-validated');
        if (elements.registerFriendFeedback) {
            elements.registerFriendFeedback.classList.add('d-none');
            elements.registerFriendFeedback.textContent = '';
        }
        if (elements.friendAddressSelect) {
            elements.friendAddressSelect.disabled = state.addresses.length === 0;
        }
    }

    function showRegisterFriendFeedback(message, variant = 'danger') {
        if (!elements.registerFriendFeedback) return;
        elements.registerFriendFeedback.textContent = message;
        elements.registerFriendFeedback.classList.remove('d-none', 'alert-danger', 'alert-warning', 'alert-success');
        elements.registerFriendFeedback.classList.add(`alert-${variant}`);
    }

    async function openRegisterFriendModal() {
        if (!state.session) return;
        try {
            if (state.addresses.length === 0) {
                elements.friendAddressSelect.innerHTML = '<option value="">Loading addresses…</option>';
                elements.friendAddressSelect.disabled = true;
                await loadAddressesIfNeeded();
            }
            renderAddressOptions();
            if (elements.friendAddressSelect) {
                elements.friendAddressSelect.value = '';
            }
            if (elements.registerFriendFeedback) {
                showRegisterFriendFeedback('', 'success');
                elements.registerFriendFeedback.classList.add('d-none');
            }
            registerFriendModalInstance.show();
        } catch (error) {
            console.error('Address load failed', error);
            showRegisterFriendFeedback(error.message || 'Unable to load addresses.');
        }
    }

    async function handleRegisterFriendSubmit(event) {
        event.preventDefault();
        if (!elements.registerFriendForm.checkValidity()) {
            elements.registerFriendForm.classList.add('was-validated');
            return;
        }
        elements.registerFriendForm.classList.remove('was-validated');
        const formData = new FormData(elements.registerFriendForm);
        const payload = {
            name: (formData.get('name') || '').toString().trim(),
            shopName: (formData.get('shopName') || '').toString().trim(),
            phone: (formData.get('phone') || '').toString().trim(),
            addressId: Number(formData.get('addressId')),
            registerarCustomerId: state.session.customerId
        };
        elements.registerFriendSubmitBtn.disabled = true;
        elements.registerFriendSpinner.classList.remove('d-none');
        elements.registerFriendFeedback?.classList.add('d-none');
        try {
            const response = await fetchJson(API.registerFriend, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            showToast({ title: 'Friend registered', body: response.message || 'We sent them their password via SMS.', variant: 'success' });
            registerFriendModalInstance.hide();
            resetRegisterFriendForm();
        } catch (error) {
            console.error('Register friend failed', error);
            showRegisterFriendFeedback(error.message || 'Registration failed.');
        } finally {
            elements.registerFriendSubmitBtn.disabled = false;
            elements.registerFriendSpinner.classList.add('d-none');
        }
    }

    async function fetchInitialData() {
        showSkeletonGoods();
        const [categories, suppliers] = await Promise.all([
            fetchJson(API.categories),
            fetchJson(API.suppliers)
        ]);

        state.categories = (categories.categories || []).filter(cat => Number(cat.isAvailable) === 1);
        renderCategories();

        state.suppliers = (suppliers.suppliers || []).filter(sup => Number(sup.isVisible) === 1);
        renderSuppliers();

        await loadGoodsForContext({ type: 'home', append: false });
    }

    function transformSupplierGoods(payload) {
        const supplier = payload?.supplier || {};
        const goods = Array.isArray(payload?.goods) ? payload.goods : [];
        return goods.map(item => {
            const basePrice = Number(item?.discountPrice) > 0 ? Number(item.discountPrice) : Number(item?.price ?? 0);
            const offer = {
                supplierGoodsId: item.supplierGoodsId,
                goodsId: item.goodsId,
                price: basePrice,
                minOrder: Number(item.minOrder) || 1,
                shopId: supplier.shopId,
                shopName: supplier.shopName,
                shopType: supplier.shopType,
                phone: supplier.phone
            };
            return {
                goodsId: item.goodsId,
                name: item.name,
                description: item.description,
                imageUrl: item.imageUrl,
                categoryName: item.categoryName,
                commission: item.commission ?? 0,
                priority: item.priority,
                primarySupplier: offer,
                supplierName: supplier.shopName,
                supplierOffers: [offer],
                lowestPrice: basePrice
            };
        });
    }

    function updateLoadMoreButton() {
        if (!elements.loadMoreGoodsBtn) return;
        const context = state.pagination.context;
        const isSupplierContext = context === 'supplier';
        const hasMore = state.pagination.hasMore[context] !== false;
        const shouldShow = !isSupplierContext && hasMore;
        elements.loadMoreGoodsBtn.classList.toggle('d-none', !shouldShow);
        elements.loadMoreGoodsBtn.disabled = state.isLoadingGoods;
        if (!state.isLoadingGoods) {
            elements.loadMoreGoodsBtn.innerHTML = loadMoreDefaultLabel;
        }
    }

    function applySearchFilter() {
        if (!state.searchQuery) {
            state.filteredGoods = [...state.goods];
        } else {
            const query = state.searchQuery.toLowerCase();
            state.filteredGoods = state.goods.filter(goods =>
                goods.name?.toLowerCase().includes(query) ||
                goods.categoryName?.toLowerCase().includes(query) ||
                goods.primarySupplier?.shopName?.toLowerCase().includes(query)
            );
        }
        renderGoods();
    }

    async function loadGoodsForContext({ type, id = null, append = false }) {
        const context = ['home', 'category', 'supplier'].includes(type) ? type : 'home';
        state.pagination.context = context;
        state.pagination.contextId = id ?? null;
        if (!append) {
            if (context !== 'supplier') {
                state.pagination.offsets[context] = 0;
                state.pagination.hasMore[context] = true;
            } else {
                state.pagination.hasMore[context] = false;
            }
        }
        if (!append) {
            showSkeletonGoods();
        }
        state.isLoadingGoods = true;
        updateLoadMoreButton();
        try {
            const limit = state.pagination.limit;
            const offset = state.pagination.offsets[context] || 0;
            let response;
            if (context === 'home') {
                response = await fetchJson(`${API.featuredGoods}?offset=${offset}&limit=${limit}`);
            } else if (context === 'category') {
                if (!id) {
                    throw new Error('Select a category to load goods.');
                }
                response = await fetchJson(API.goodsByCategory(id, offset, limit));
            } else {
                if (!id) {
                    throw new Error('Select a supplier to load goods.');
                }
                response = await fetchJson(API.goodsBySupplier(id));
            }
            let newGoods = Array.isArray(response.goods) ? response.goods : [];
            if (context === 'supplier') {
                newGoods = transformSupplierGoods(response);
                state.pagination.hasMore.supplier = false;
            } else if (newGoods.length === 0) {
                state.pagination.hasMore[context] = false;
            } else {
                state.pagination.hasMore[context] = true;
            }

            if (append && newGoods.length === 0) {
                state.pagination.hasMore[context] = false;
                showToast({ title: 'All caught up', body: 'No more goods available for now.', variant: 'info' });
                return;
            }

            if (append) {
                state.goods.push(...newGoods);
            } else {
                state.goods = newGoods;
            }

            if (context !== 'supplier') {
                state.pagination.offsets[context] = offset + state.pagination.limit;
            } else {
                state.pagination.offsets[context] = 0;
            }

            applySearchFilter();
        } catch (error) {
            console.error('Goods load error', error);
            showToast({ title: 'Load failed', body: error.message || 'Unable to load goods.', variant: 'danger' });
            if (!append) {
                state.goods = [];
                state.filteredGoods = [];
                renderGoods();
            }
            throw error;
        } finally {
            state.isLoadingGoods = false;
            updateLoadMoreButton();
        }
    }

    async function showHomeGoods() {
        state.activeCategoryId = null;
        state.activeSupplierId = null;
        renderSuppliers();
        await loadGoodsForContext({ type: 'home', append: false });
        highlightActiveChips();
    }

    async function handleCategorySelection(categoryId) {
        if (!categoryId) {
            await showHomeGoods();
            return;
        }
        state.activeCategoryId = categoryId;
        state.activeSupplierId = null;
        renderSuppliers();
        await loadGoodsForContext({ type: 'category', id: categoryId, append: false });
        highlightActiveChips();
    }

    async function handleSupplierSelection(supplierId) {
        state.activeSupplierId = supplierId;
        state.activeCategoryId = null;
        renderSuppliers();
        await loadGoodsForContext({ type: 'supplier', id: supplierId, append: false });
        highlightActiveChips();
    }

    function renderCategories() {
        elements.categoryCountBadge.textContent = state.categories.length.toString();
        elements.homeCategoryChips.innerHTML = '';
        const allChip = createChipElement(
            { id: null, name: 'All categories' },
            state.activeCategoryId === null && state.activeSupplierId === null,
            () => showHomeGoods().catch(() => {})
        );
        elements.homeCategoryChips.appendChild(allChip);

        state.categories.forEach(category => {
            const chip = createChipElement(
                category,
                state.activeCategoryId === category.id,
                () => handleCategorySelection(category.id).catch(() => {})
            );
            elements.homeCategoryChips.appendChild(chip);
        });

        elements.categoryCardList.innerHTML = state.categories.map(category => `
            <div class="col-sm-6 col-lg-4">
                <div class="card border-0 shadow-sm rounded-4 h-100 overflow-hidden category-card" data-category-id="${category.id}">
                    <div class="ratio ratio-16x9 bg-light">
                        <img src="${category.imageUrl || 'https://via.placeholder.com/400x225'}" class="object-fit-cover" loading="lazy" alt="${category.name || 'Category'}">
                    </div>
                    <div class="card-body">
                        <h3 class="h5 fw-semibold">${category.name || 'Category'}</h3>
                        <p class="text-muted small mb-0">Tap to view goods in this category.</p>
                    </div>
                </div>
            </div>
        `).join('');
        updateHomeStats();
    }

    function createChipElement(category, isActive, onClick) {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = `chip ${isActive ? 'active' : ''}`;
        btn.textContent = category.name || 'Unknown';
        btn.addEventListener('click', async () => {
            try {
                await onClick();
            } catch (error) {
                console.error('Category action failed', error);
            }
            highlightActiveChips();
        });
        btn.dataset.categoryId = category.id ?? 'all';
        return btn;
    }

    function highlightActiveChips() {
        const chips = elements.homeCategoryChips.querySelectorAll('.chip');
        chips.forEach(chip => {
            const chipCategoryId = chip.dataset.categoryId;
            if (state.activeCategoryId === null && state.activeSupplierId === null && chipCategoryId === 'all') {
                chip.classList.add('active');
            } else if (Number(chipCategoryId) === state.activeCategoryId) {
                chip.classList.add('active');
            } else {
                chip.classList.remove('active');
            }
        });
    }

    function renderSuppliers() {
        elements.supplierList.innerHTML = state.suppliers.map(supplier => `
            <div class="col-12 col-md-6 col-xl-4">
                <div class="supplier-card ${state.activeSupplierId === supplier.shopId ? 'active' : ''}" data-supplier-id="${supplier.shopId}" data-shop-type="${supplier.shopType}">
                    <div class="supplier-avatar">
                        <i class="bi bi-shop"></i>
                    </div>
                    <div class="flex-grow-1">
                        <div class="fw-semibold">${supplier.shopName || 'Supplier'}</div>
                        <div class="text-muted small">${supplier.shopType || 'Unknown type'}</div>
                    </div>
                    <div class="text-end">
                        <span class="badge text-bg-light">
                            Priority ${supplier.priority ?? 0}
                        </span>
                    </div>
                </div>
            </div>
        `).join('');
        updateHomeStats();
    }

    function renderGoods() {
        elements.featuredGoodsCount.textContent = state.filteredGoods.length.toString();
        if (state.filteredGoods.length === 0) {
            elements.goodsGrid.innerHTML = `
                <div class="empty-state">
                    <i class="bi bi-shop-window display-6 d-block mb-3"></i>
                    <p class="mb-0">No goods found for the selected filter.</p>
                    <small class="text-muted">Try another category or supplier filter.</small>
                </div>
            `;
            updateHomeStats();
            return;
        }

        elements.goodsGrid.innerHTML = state.filteredGoods.map(goods => {
            const supplierGoodsId = goods.primarySupplier?.supplierGoodsId;
            const cartItem = state.cart.find(item => item.goodsId === goods.goodsId && item.supplierGoodsId === supplierGoodsId);
            const canAdd = !goods.primarySupplier || goods.primarySupplier.shopType?.toLowerCase() !== 'self-delivered';
            const hasCart = Boolean(cartItem);
            const quantity = cartItem?.quantity ?? goods.primarySupplier?.minOrder ?? 1;
            const basePrice = Number(goods.primarySupplier?.price ?? goods.lowestPrice ?? 0);
            const commission = Number(goods.commission ?? 0);
            const price = basePrice + commission;
            const minOrder = goods.primarySupplier?.minOrder ?? 1;
            const showOptions = Array.isArray(goods.supplierOffers) && goods.supplierOffers.length > 1;

            return `
                <article class="goods-card" data-goods-id="${goods.goodsId}">
                    <button class="border-0 bg-transparent p-0" data-action="open-detail" aria-label="View details of ${goods.name}">
                        <img src="${goods.imageUrl || 'https://via.placeholder.com/400'}" alt="${goods.name || 'Goods'}" loading="lazy">
                    </button>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <h3 class="h5 fw-semibold mb-0">${goods.name || 'Goods'}</h3>
                            <span class="badge text-bg-light">${goods.categoryName || 'Category'}</span>
                        </div>
                        <div class="supplier-chip">
                            <i class="bi bi-shop"></i>
                            ${goods.primarySupplier?.shopName || goods.supplierName || 'Supplier'}
                        </div>
                        <div class="price-tag text-primary">ETB ${price.toLocaleString(undefined, { minimumFractionDigits: 2 })}</div>
                        <div class="text-muted small">
                            Priority ${goods.priority ?? 0} &bull; Min order ${minOrder}
                        </div>
                        <div class="actions${showOptions ? '' : ' flex-column'}">
                            ${showOptions ? `
                                <button class="btn btn-outline-primary btn-sm" data-action="see-options" data-goods-id="${goods.goodsId}">
                                    <i class="bi bi-list-ul me-1"></i>
                                    See options
                                </button>
                            ` : ''}
                            ${canAdd ? renderAddToCartControl(goods.goodsId, goods.primarySupplier?.supplierGoodsId, hasCart, quantity, minOrder) : `
                                <button class="btn btn-outline-secondary btn-sm w-100" data-action="self-delivered-warning">
                                    <i class="bi bi-geo-alt-fill me-1"></i>
                                    Visit shop
                                </button>
                            `}
                        </div>
            </div>
        </article>
    `;
        }).join('');
        updateHomeStats();
    }

    function updateHomeStats(cartQuantity = null) {
        if (elements.homeGoodsStat) {
            elements.homeGoodsStat.textContent = state.filteredGoods.length.toString();
        }
        if (elements.homeSuppliersStat) {
            elements.homeSuppliersStat.textContent = state.suppliers.length.toString();
        }
        if (elements.homeCategoriesStat) {
            elements.homeCategoriesStat.textContent = state.categories.length.toString();
        }
        if (elements.homeCartStat) {
            const quantity = typeof cartQuantity === 'number'
                ? cartQuantity
                : state.cart.reduce((sum, item) => sum + item.quantity, 0);
            elements.homeCartStat.textContent = quantity.toString();
        }
    }

    function renderAddToCartControl(goodsId, supplierGoodsId, hasCart, quantity, minOrder) {
        if (!hasCart) {
            return `
                <button class="btn btn-primary btn-sm" data-action="add-to-cart" data-goods-id="${goodsId}" data-supplier-goods-id="${supplierGoodsId}">
                    <i class="bi bi-cart-plus me-1"></i>
                    Add to cart
                </button>
            `;
        }
        return `
            <div class="quantity-control w-100" data-goods-id="${goodsId}" data-supplier-goods-id="${supplierGoodsId}">
                <button class="btn btn-primary btn-sm" data-action="decrease-qty" aria-label="Decrease quantity">
                    <i class="bi bi-dash-lg"></i>
                </button>
                <div class="text-center flex-grow-1">
                    <div class="fw-semibold">${quantity}</div>
                    <small class="text-muted">Min ${minOrder}</small>
                </div>
                <button class="btn btn-primary btn-sm" data-action="increase-qty" aria-label="Increase quantity">
                    <i class="bi bi-plus-lg"></i>
                </button>
            </div>
        `;
    }

    function showSkeletonGoods() {
        elements.goodsGrid.innerHTML = Array.from({ length: 6 }).map(() => `
            <div class="goods-card">
                <div class="skeleton" style="width: 100%; height: 180px;"></div>
                <div class="card-body">
                    <div class="skeleton" style="width: 60%; height: 16px;"></div>
                    <div class="skeleton" style="width: 40%; height: 14px;"></div>
                    <div class="skeleton" style="width: 80%; height: 18px;"></div>
                    <div class="skeleton" style="width: 50%; height: 32px;"></div>
                </div>
            </div>
        `).join('');
    }


    function showToast({ title = 'Notification', body = '', variant = 'primary' }) {
        const wrapper = document.createElement('div');
        wrapper.innerHTML = `
            <div class="toast align-items-center border-0 text-white bg-${variant}" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        <strong class="d-block">${title}</strong>
                        <div>${body}</div>
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        `;
        const toastEl = wrapper.firstElementChild;
        elements.toastContainer.appendChild(toastEl);
        const toast = new bootstrap.Toast(toastEl, { delay: 3500 });
        toast.show();
        toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
    }

    function renderCartCounter() {
        const totalItems = state.cart.length;
        const totalQuantity = state.cart.reduce((sum, item) => sum + item.quantity, 0);
        elements.cartCountBadge.textContent = totalItems.toString();
        elements.cartCountBadgeMobile.textContent = totalItems.toString();
        elements.cartCountBadge.classList.toggle('d-none', totalItems === 0);
        elements.cartCountBadgeMobile.classList.toggle('d-none', totalItems === 0);

        elements.cartSummaryItems.textContent = totalItems.toString();
        elements.cartSummaryQuantity.textContent = totalQuantity.toString();
        const totalAmount = state.cart.reduce((sum, item) => sum + (getCartItemUnitPrice(item) * item.quantity), 0);
        elements.cartSummaryAmount.textContent = `ETB ${totalAmount.toLocaleString(undefined, { minimumFractionDigits: 2 })}`;
        updateHomeStats(totalQuantity);
    }

    function renderCartModal() {
        if (state.cart.length === 0) {
            elements.cartItemsContainer.innerHTML = `
                <div class="empty-state">
                    <i class="bi bi-cart-x display-6 d-block mb-3"></i>
                    <p class="mb-0">Your cart is empty.</p>
                    <small class="text-muted">Add goods from the catalogue to place an order.</small>
                </div>
            `;
            renderCartCounter();
            return;
        }

        elements.cartItemsContainer.innerHTML = state.cart.map(item => `
            <div class="cart-item-card" data-goods-id="${item.goodsId}" data-supplier-goods-id="${item.supplierGoodsId}">
                <img src="${item.imageUrl || 'https://via.placeholder.com/120'}" alt="${item.name || 'Goods'}" loading="lazy">
                <div class="flex-grow-1">
                    <div class="fw-semibold">${item.name || 'Goods'}</div>
                    <div class="text-muted small">${item.supplierName || 'Supplier'} &bull; Min ${item.minOrder}</div>
                    <div class="text-primary fw-semibold">ETB ${getCartItemUnitPrice(item).toLocaleString(undefined, { minimumFractionDigits: 2 })}</div>
                </div>
                <div class="d-flex flex-column align-items-end gap-2">
                    <div class="btn-group btn-group-sm" role="group">
                        <button class="btn btn-outline-primary" data-action="decrease-qty">
                            <i class="bi bi-dash-lg"></i>
                        </button>
                        <button class="btn btn-light" disabled>${item.quantity}</button>
                        <button class="btn btn-outline-primary" data-action="increase-qty">
                            <i class="bi bi-plus-lg"></i>
                        </button>
                    </div>
                    <button class="btn btn-outline-danger btn-sm" data-action="remove-item">
                        <i class="bi bi-trash3 me-1"></i>
                        Remove
                    </button>
                </div>
            </div>
        `).join('');

        renderCartCounter();
    }

    function addToCart(goods, supplierOffer) {
        if (!supplierOffer) {
            showToast({ title: 'Unavailable', body: 'No supplier information found for this goods.', variant: 'warning' });
            return;
        }

        if ((supplierOffer.shopType || '').toLowerCase() === 'self-delivered') {
            showToast({ title: 'Visit supplier', body: 'Self-delivered goods must be purchased directly from the supplier.', variant: 'warning' });
            return;
        }

        const existing = state.cart.find(item => item.goodsId === goods.goodsId && item.supplierGoodsId === supplierOffer.supplierGoodsId);
        const basePrice = Number(supplierOffer.price) || 0;
        const commission = Number(goods.commission ?? 0);

        if (existing) {
            existing.quantity = Math.max(existing.quantity + supplierOffer.minOrder, supplierOffer.minOrder);
            existing.basePrice = basePrice;
            existing.commission = commission;
            existing.price = basePrice + commission;
        } else {
            state.cart.push({
                goodsId: goods.goodsId,
                supplierGoodsId: supplierOffer.supplierGoodsId,
                name: goods.name,
                imageUrl: goods.imageUrl,
                price: basePrice + commission,
                basePrice,
                commission,
                quantity: Number(supplierOffer.minOrder) || 1,
                minOrder: Number(supplierOffer.minOrder) || 1,
                supplierName: supplierOffer.shopName || goods.supplierName,
                supplierType: supplierOffer.shopType || '',
                supplierPhone: supplierOffer.phone || ''
            });
        }

        persistCart();
        renderGoods();
        renderCartCounter();
        showToast({
            title: 'Added to cart',
            body: `${goods.name} from ${supplierOffer.shopName} added to cart.`,
            variant: 'success'
        });
    }

    function updateCartQuantity(goodsId, supplierGoodsId, delta) {
        const item = state.cart.find(cartItem => cartItem.goodsId === goodsId && cartItem.supplierGoodsId === supplierGoodsId);
        if (!item) return;

        const newQuantity = item.quantity + delta;
        if (newQuantity < item.minOrder) {
            removeCartItem(goodsId, supplierGoodsId);
            showToast({ title: 'Item removed', body: `${item.name || 'Goods'} removed from cart.`, variant: 'info' });
            return;
        }
        item.quantity = newQuantity;
        persistCart();
        renderGoods();
        renderCartModal();
    }

    function removeCartItem(goodsId, supplierGoodsId) {
        state.cart = state.cart.filter(item => !(item.goodsId === goodsId && item.supplierGoodsId === supplierGoodsId));
        persistCart();
        renderGoods();
        renderCartModal();
    }

    function clearCart() {
        if (state.cart.length === 0) return;
        state.cart = [];
        persistCart();
        renderGoods();
        renderCartModal();
    }

    async function handlePlaceOrder() {
        if (state.cart.length === 0) {
            showToast({ title: 'Cart empty', body: 'Add goods before placing an order.', variant: 'warning' });
            return;
        }
        try {
            elements.placeOrderBtn.disabled = true;
            elements.placeOrderBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Submitting…';
            const payload = {
                customerId: state.session.customerId,
                items: state.cart.map(item => ({
                    supplierGoodsId: item.supplierGoodsId,
                    goodsId: item.goodsId,
                    quantity: item.quantity
                }))
            };
            const response = await fetchJson(API.orderFromCart, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            showToast({ title: 'Order placed', body: response.message || 'Your order has been submitted to the team.', variant: 'success' });
            clearCart();
            bootstrap.Modal.getInstance(document.getElementById('cartModal')).hide();
        } catch (error) {
            console.error('Order error', error);
            showToast({ title: 'Order failed', body: error.message || 'Could not submit order. Try again later.', variant: 'danger' });
        } finally {
            elements.placeOrderBtn.disabled = false;
            elements.placeOrderBtn.innerHTML = '<i class="bi bi-bag-check me-2"></i>Place order';
        }
    }

    async function loadMoreGoods() {
        const context = state.pagination.context;
        if (context === 'supplier') {
            showToast({ title: 'All caught up', body: 'Supplier goods are fully loaded.', variant: 'info' });
            return;
        }
        if (!state.pagination.hasMore[context]) {
            showToast({ title: 'All caught up', body: 'No more goods to display yet.', variant: 'info' });
            return;
        }
        try {
            await loadGoodsForContext({
                type: context,
                id: state.pagination.contextId,
                append: true
            });
        } catch (error) {
            console.error('Failed to load more goods', error);
        }
    }

    function attachEventListeners() {
        elements.dismissAndroidBanner.addEventListener('click', dismissAndroidBanner);
        elements.androidDownloadModal.addEventListener('hidden.bs.modal', handleAndroidModalHidden);

        elements.navButtons.forEach(button => {
            button.addEventListener('click', () => {
                const target = button.dataset.screenTarget;
                switchScreen(target);
                elements.navButtons.forEach(btn => btn.classList.toggle('active', btn === button));
            });
        });

        elements.categoryCardList.addEventListener('click', async event => {
            const card = event.target.closest('.category-card');
            if (!card) return;
            const categoryId = Number(card.dataset.categoryId);
            try {
                await handleCategorySelection(categoryId);
                switchScreen('homeScreen');
            } catch (error) {
                console.error('Category load failed', error);
            }
        });

        elements.supplierList.addEventListener('click', async event => {
            const card = event.target.closest('.supplier-card');
            if (!card) return;
            const supplierId = Number(card.dataset.supplierId);
            try {
                await handleSupplierSelection(supplierId);
                switchScreen('homeScreen');
            } catch (error) {
                console.error('Supplier load failed', error);
            }
        });

        elements.goodsGrid.addEventListener('click', async (event) => {
            const actionButton = event.target.closest('[data-action]');
            if (!actionButton) return;
            const action = actionButton.dataset.action;
            const goodsCard = actionButton.closest('.goods-card');
            if (!goodsCard) return;
            const goodsId = Number(actionButton.dataset.goodsId || goodsCard.dataset.goodsId);
            const goods = state.goods.find(g => Number(g.goodsId) === goodsId);
            if (!goods) return;

            if (action === 'self-delivered-warning') {
                showToast({ title: 'Visit supplier', body: 'Self-delivered goods must be collected at the supplier shop.', variant: 'warning' });
                return;
            }

            if (action === 'open-detail') {
                openGoodsDetail(goods);
                return;
            }

            if (action === 'see-options') {
                openOptionsModal(goods);
                return;
            }

            const supplierGoodsId = Number(actionButton.dataset.supplierGoodsId || goods.primarySupplier?.supplierGoodsId);
            const supplierOffer = goods.primarySupplier && Number(goods.primarySupplier.supplierGoodsId) === supplierGoodsId
                ? goods.primarySupplier
                : (goods.supplierOffers || []).find(offer => Number(offer.supplierGoodsId) === supplierGoodsId);

            if (action === 'add-to-cart') {
                addToCart(goods, supplierOffer || goods.primarySupplier);
                renderCartModal();
                return;
            }

            if (action === 'increase-qty') {
                updateCartQuantity(goodsId, supplierGoodsId, supplierOffer?.minOrder || 1);
                return;
            }

            if (action === 'decrease-qty') {
                updateCartQuantity(goodsId, supplierGoodsId, -(supplierOffer?.minOrder || 1));
                return;
            }
        });

        elements.cartItemsContainer.addEventListener('click', (event) => {
            const actionButton = event.target.closest('[data-action]');
            if (!actionButton) return;
            const card = actionButton.closest('.cart-item-card');
            if (!card) return;
            const goodsId = Number(card.dataset.goodsId);
            const supplierGoodsId = Number(card.dataset.supplierGoodsId);
            const action = actionButton.dataset.action;

            if (action === 'decrease-qty') {
                const item = state.cart.find(i => i.goodsId === goodsId && i.supplierGoodsId === supplierGoodsId);
                updateCartQuantity(goodsId, supplierGoodsId, -Math.max(1, item?.minOrder || 1));
            } else if (action === 'increase-qty') {
                const item = state.cart.find(i => i.goodsId === goodsId && i.supplierGoodsId === supplierGoodsId);
                updateCartQuantity(goodsId, supplierGoodsId, Math.max(1, item?.minOrder || 1));
            } else if (action === 'remove-item') {
                removeCartItem(goodsId, supplierGoodsId);
            }
        });

        elements.clearCartBtn.addEventListener('click', () => {
            if (state.cart.length === 0) return;
            clearCart();
            showToast({ title: 'Cart cleared', body: 'All items removed from cart.', variant: 'info' });
        });

        elements.placeOrderBtn.addEventListener('click', handlePlaceOrder);

        document.getElementById('cartModal').addEventListener('shown.bs.modal', () => {
            renderCartModal();
        });

        elements.reloadFeaturedBtn.addEventListener('click', async () => {
            try {
                await loadGoodsForContext({
                    type: state.pagination.context,
                    id: state.pagination.contextId,
                    append: false
                });
                showToast({ title: 'Refreshed', body: 'Latest goods loaded.', variant: 'success' });
            } catch (err) {
                showToast({ title: 'Refresh failed', body: err.message, variant: 'danger' });
            }
        });

        elements.loadMoreGoodsBtn.addEventListener('click', loadMoreGoods);

        elements.globalSearchInput?.addEventListener('input', (event) => {
            state.searchQuery = event.target.value.trim().toLowerCase();
            applySearchFilter();
        });

        elements.supplierSearchInput?.addEventListener('input', (event) => {
            const query = event.target.value.trim().toLowerCase();
            const cards = elements.supplierList.querySelectorAll('.supplier-card');
            cards.forEach(card => {
                const text = card.textContent.toLowerCase();
                card.parentElement.classList.toggle('d-none', !text.includes(query));
            });
        });

        elements.logoutBtn.addEventListener('click', () => {
            localStorage.removeItem(sessionKey);
            window.location.href = 'login.html';
        });

        elements.detailAddToCartBtn.addEventListener('click', () => {
            const goodsId = Number(elements.detailAddToCartBtn.dataset.goodsId);
            const goods = state.goods.find(g => Number(g.goodsId) === goodsId);
            if (!goods) return;
            addToCart(goods, goods.primarySupplier);
            renderCartModal();
            detailModalInstance.hide();
        });

        document.getElementById('optionsModal').addEventListener('hidden.bs.modal', () => {
            elements.optionsList.innerHTML = '';
        });

        elements.registerFriendBtn?.addEventListener('click', () => {
            openRegisterFriendModal();
        });
        elements.registerFriendForm?.addEventListener('submit', handleRegisterFriendSubmit);
        elements.registerFriendModal?.addEventListener('hidden.bs.modal', resetRegisterFriendForm);
        elements.orderHistoryBtn?.addEventListener('click', () => {
            window.location.href = 'orderHistory.html';
        });
    }

    function switchScreen(targetId) {
        Object.entries(elements.screens).forEach(([id, section]) => {
            section.classList.toggle('d-none', id !== targetId);
        });
    }

    async function openGoodsDetail(goods) {
        elements.detailImage.src = goods.imageUrl || 'https://via.placeholder.com/600';
        elements.detailImage.alt = goods.name || 'Goods';
        elements.detailName.textContent = goods.name || 'Goods';
        elements.detailCategory.textContent = goods.categoryName || 'Category';
        const price = (goods.primarySupplier?.price ?? goods.lowestPrice ?? 0) + Number(goods.commission ?? 0);
        elements.detailPrice.textContent = `ETB ${price.toLocaleString(undefined, { minimumFractionDigits: 2 })}`;
        elements.detailSupplier.innerHTML = `<i class="bi bi-shop"></i>${goods.primarySupplier?.shopName || goods.supplierName || 'Supplier'}`;
        elements.detailDescription.innerHTML = goods.description || '<span class="text-muted">No description provided.</span>';
        elements.detailAddToCartBtn.dataset.goodsId = goods.goodsId;

        elements.detailComments.innerHTML = '<div class="text-center text-muted small">Loading comments…</div>';
        detailModalInstance.show();

        try {
            const comments = await fetchJson(API.comments, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ goodsId: goods.goodsId })
            });
            if (!Array.isArray(comments) || comments.length === 0) {
                elements.detailComments.innerHTML = '<div class="text-muted small text-center">No comments yet.</div>';
                return;
            }
            elements.detailComments.innerHTML = comments.map(comment => `
                <div class="border-bottom pb-2 mb-2">
                    <div class="d-flex justify-content-between">
                        <strong>${comment.customerName || 'Customer'}</strong>
                        <span class="text-warning">${'★'.repeat(Number(comment.StarValue) || 0)}</span>
                    </div>
                    <div class="text-muted small">${comment.addressName || ''}</div>
                    <p class="mb-0 small">${comment.comment || ''}</p>
                </div>
            `).join('');
        } catch (err) {
            elements.detailComments.innerHTML = `<div class="text-danger small text-center">${err.message}</div>`;
        }
    }

    async function openOptionsModal(goods) {
        elements.optionsModalLabel.textContent = `Supplier options — ${goods.name}`;
        elements.optionsList.innerHTML = '<div class="text-center text-muted">Loading supplier options…</div>';
        optionsModalInstance.show();
        try {
            const result = await fetchJson(API.supplierOptions(goods.goodsId));
            const offers = result.options || [];
            if (offers.length === 0) {
                elements.optionsList.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-shop display-6 d-block mb-3"></i>
                        <p class="mb-0">No supplier listings found for this goods.</p>
                    </div>
                `;
                return;
            }
            elements.optionsList.innerHTML = offers.map(offer => {
                const displayPrice = ((Number(offer.price) || 0) + Number(goods.commission ?? 0))
                    .toLocaleString(undefined, { minimumFractionDigits: 2 });
                return `
                    <div class="option-row" data-goods-id="${goods.goodsId}" data-supplier-goods-id="${offer.supplierGoodsId}">
                        <div>
                            <div class="fw-semibold">${offer.shopName || 'Supplier'}</div>
                            <div class="text-muted small">${offer.shopType || 'Shop type'}</div>
                        </div>
                        <div class="fw-semibold text-primary">
                            ETB ${displayPrice}
                        </div>
                        <div class="text-muted small">Min order ${offer.minOrder ?? 1}</div>
                        <button class="btn btn-primary btn-sm" data-action="add-option-to-cart">
                            <i class="bi bi-cart-plus me-1"></i>Add
                        </button>
                    </div>
                `;
            }).join('');
        } catch (err) {
            elements.optionsList.innerHTML = `<div class="text-danger text-center">${err.message}</div>`;
        }
    }

    elements.optionsList.addEventListener('click', (event) => {
        const button = event.target.closest('[data-action="add-option-to-cart"]');
        if (!button) return;
        const row = button.closest('.option-row');
        const goodsId = Number(row.dataset.goodsId);
        const supplierGoodsId = Number(row.dataset.supplierGoodsId);
        const goods = state.goods.find(g => Number(g.goodsId) === goodsId);
        if (!goods) return;
        const offer = (goods.supplierOffers || []).find(opt => Number(opt.supplierGoodsId) === supplierGoodsId);
        addToCart(goods, offer);
        renderCartModal();
        optionsModalInstance.hide();
    });

    async function init() {
        state.session = sessionOrRedirect();
        if (!state.session) return;

        attachEventListeners();
        renderCartCounter();

        try {
            await Promise.all([fetchProfile(), fetchInitialData()]);
        } catch (err) {
            console.error('Bootstrap error', err);
            showToast({ title: 'Load failed', body: err.message || 'Failed to load initial data.', variant: 'danger' });
        }

        showAndroidBannerIfNeeded();
        showAndroidModalIfNeeded();
    }

    init();
</script>
</body>
</html>
