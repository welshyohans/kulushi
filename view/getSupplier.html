<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Supplier Directory</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
        crossorigin="anonymous"
    >
    <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    >
    <style>
        body {
            min-height: 100vh;
            background: radial-gradient(circle at top, #f3f6ff, #edf3ff 40%, #e8efff 100%);
        }

        .page-title {
            font-weight: 700;
            letter-spacing: 0.02em;
        }

        .card {
            border: none;
            box-shadow: 0 18px 30px -20px rgba(63, 81, 181, 0.35);
            border-radius: 1rem;
        }

        .badge-pill {
            border-radius: 50rem;
        }

        .table thead th {
            border-top: none;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 0.75rem;
            background: #f3f5ff;
        }

        .table tbody tr {
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }

        .table tbody tr:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 20px -18px rgba(0, 0, 0, 0.45);
        }

        #supplierSearch {
            border-radius: 2rem;
        }

        .modal-content {
            border-radius: 1rem;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1.5rem;
            color: #6c757d;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg bg-white border-bottom shadow-sm">
    <div class="container">
        <span class="navbar-brand fw-semibold text-primary">
            <i class="bi bi-truck-front-fill me-2"></i>
            Supplier Control Center
        </span>
        <button class="btn btn-outline-primary" id="refreshSuppliersBtn">
            <i class="bi bi-arrow-clockwise me-1"></i>
            Refresh
        </button>
    </div>
</nav>

<main class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10 col-xl-9">
            <div class="card">
                <div class="card-header bg-white pt-4 pb-3 border-0">
                    <div class="d-flex flex-column flex-md-row justify-content-between gap-3">
                        <div>
                            <h1 class="h4 page-title mb-1">Suppliers</h1>
                            <p class="text-muted mb-0">View and update supplier contact details with ease.</p>
                        </div>
                        <div class="flex-grow-1 flex-md-grow-0">
                            <label for="supplierSearch" class="form-label text-muted small mb-2">
                                <i class="bi bi-search-heart me-1"></i>
                                Quick search
                            </label>
                            <input
                                type="search"
                                id="supplierSearch"
                                class="form-control"
                                placeholder="Search by name, phone, shop type or ID"
                            >
                        </div>
                    </div>
                </div>
                <div class="card-body pt-0">
                    <div class="alert d-none" id="feedbackAlert" role="alert"></div>
                    <div class="table-responsive">
                        <table class="table align-middle">
                            <thead>
                            <tr>
                                <th scope="col">Shop ID</th>
                                <th scope="col">Shop Name</th>
                                <th scope="col">Phone</th>
                                <th scope="col">Shop Type</th>
                                <th scope="col">Priority</th>
                                <th scope="col">Password</th>
                                <th scope="col" class="text-end">Action</th>
                            </tr>
                            </thead>
                            <tbody id="supplierTableBody">
                            <tr>
                                <td colspan="7" class="p-0">
                                    <div class="empty-state" id="supplierEmptyState">
                                        <div class="spinner-border text-primary mb-3"></div>
                                        <p class="mb-0">Loading suppliers…</p>
                                        <small class="text-muted">Please wait a moment.</small>
                                    </div>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer bg-white border-0 d-flex justify-content-between align-items-center py-3">
                    <small class="text-muted">
                        <i class="bi bi-people-fill me-1"></i>
                        <span id="supplierCount">0</span> supplier(s) found
                    </small>
                    <small class="text-muted">
                        Last refreshed: <span id="supplierLastRefresh">—</span>
                    </small>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Edit supplier modal -->
<div class="modal fade" id="editSupplierModal" tabindex="-1" aria-labelledby="editSupplierModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <form id="editSupplierForm" novalidate>
                <div class="modal-header border-0">
                    <h2 class="modal-title fs-5" id="editSupplierModalLabel">
                        <i class="bi bi-pencil-square me-2 text-primary"></i>
                        Update supplier details
                    </h2>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body pt-0">
                    <input type="hidden" id="editSupplierId">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="editShopName" class="form-label fw-semibold">Shop name</label>
                            <input type="text" class="form-control" id="editShopName" required>
                            <div class="invalid-feedback">Shop name is required.</div>
                        </div>
                        <div class="col-md-6">
                            <label for="editPhone" class="form-label fw-semibold">Phone</label>
                            <input type="tel" class="form-control" id="editPhone" required pattern=".{6,}">
                            <div class="invalid-feedback">Enter a valid phone number.</div>
                        </div>
                        <div class="col-md-6">
                            <label for="editPassword" class="form-label fw-semibold">Password</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="editPassword" minlength="4" required>
                                <button class="btn btn-outline-secondary" type="button" id="togglePasswordBtn">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <div class="invalid-feedback">Password must be at least 4 characters long.</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="editShopType" class="form-label fw-semibold">Shop type</label>
                            <input type="text" class="form-control" id="editShopType" readonly>
                        </div>
                        <div class="col-md-6">
                            <label for="editPriority" class="form-label fw-semibold">Priority</label>
                            <input type="number" class="form-control" id="editPriority" readonly>
                        </div>
                        <div class="col-md-6">
                            <label for="editVisibility" class="form-label fw-semibold">Visibility</label>
                            <input type="text" class="form-control" id="editVisibility" readonly>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <span class="spinner-border spinner-border-sm d-none" id="editFormSpinner" role="status" aria-hidden="true"></span>
                        <span id="editFormSubmitText">Save changes</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
        crossorigin="anonymous"></script>
<script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
    crossorigin="anonymous"
></script>
<script>
    (function ($) {
        'use strict';

        const supplierCache = new Map();

        function showAlert(type, message) {
            const alertEl = $('#feedbackAlert');
            alertEl.removeClass('d-none alert-success alert-danger alert-warning alert-info')
                .addClass(`alert alert-${type}`)
                .text(message);

            setTimeout(() => alertEl.addClass('d-none'), 4000);
        }

        function formatDateTime(date) {
            if (!(date instanceof Date) || Number.isNaN(date.getTime())) {
                return '—';
            }
            return date.toLocaleString();
        }

        function renderRow(supplier) {
            const maskedPassword = supplier.password
                ? '•'.repeat(Math.min(supplier.password.length, 10))
                : '—';

            return $(`
                <tr data-supplier-id="${supplier.shopId}">
                    <th scope="row">#${supplier.shopId}</th>
                    <td>
                        <div class="fw-semibold">${supplier.shopName || '—'}</div>
                        <small class="text-muted">${supplier.shopDetail || ''}</small>
                    </td>
                    <td>
                        <span class="badge bg-light text-dark badge-pill">
                            <i class="bi bi-telephone-fill me-1"></i>${supplier.phone || '—'}
                        </span>
                    </td>
                    <td>${supplier.shopType || '—'}</td>
                    <td>
                        <span class="badge bg-primary-subtle text-primary-emphasis">
                            ${supplier.priority ?? '—'}
                        </span>
                    </td>
                    <td>${maskedPassword}</td>
                    <td class="text-end">
                        <button class="btn btn-outline-primary btn-sm btn-edit-supplier">
                            <i class="bi bi-pencil-square me-1"></i>
                            Edit
                        </button>
                    </td>
                </tr>
            `);
        }

        function renderSuppliers(suppliers) {
            const tbody = $('#supplierTableBody');
            const emptyState = $('#supplierEmptyState');

            tbody.empty();
            supplierCache.clear();

            if (!Array.isArray(suppliers) || suppliers.length === 0) {
                tbody.append(`
                    <tr>
                        <td colspan="7">
                            <div class="empty-state">
                                <i class="bi bi-database-x display-6 d-block mb-2 text-danger"></i>
                                <p class="mb-0">No suppliers found.</p>
                                <small class="text-muted">Import suppliers into the database to begin.</small>
                            </div>
                        </td>
                    </tr>
                `);
                $('#supplierCount').text('0');
                return;
            }

            suppliers.forEach((supplier) => {
                supplierCache.set(supplier.shopId, supplier);
                tbody.append(renderRow(supplier));
            });

            emptyState.hide();
            $('#supplierCount').text(String(suppliers.length));
            $('#supplierLastRefresh').text(formatDateTime(new Date()));
        }

        function fetchSuppliers() {
            $.ajax({
                url: '../api/getSupplier.php',
                method: 'GET',
                dataType: 'json',
                beforeSend() {
                    $('#supplierTableBody').html(`
                        <tr>
                            <td colspan="7">
                                <div class="empty-state">
                                    <div class="spinner-border text-primary mb-3"></div>
                                    <p class="mb-0">Fetching supplier records…</p>
                                    <small class="text-muted">Hang tight, this will only take a few seconds.</small>
                                </div>
                            </td>
                        </tr>
                    `);
                }
            }).done((response) => {
                if (response.success) {
                    renderSuppliers(response.suppliers);
                } else {
                    $('#supplierTableBody').html(`
                        <tr>
                            <td colspan="7">
                                <div class="empty-state">
                                    <i class="bi bi-exclamation-triangle display-6 d-block mb-3 text-warning"></i>
                                    <p class="mb-0">${response.message || 'Failed to load suppliers.'}</p>
                                </div>
                            </td>
                        </tr>
                    `);
                }
            }).fail(() => {
                $('#supplierTableBody').html(`
                    <tr>
                        <td colspan="7">
                            <div class="empty-state">
                                <i class="bi bi-wifi-off display-6 d-block mb-3 text-danger"></i>
                                <p class="mb-0">Cannot reach the server.</p>
                                <small class="text-muted">Check your connection, then refresh.</small>
                            </div>
                        </td>
                    </tr>
                `);
            });
        }

        function filterSuppliers(query) {
            const normalized = query.trim().toLowerCase();
            $('#supplierTableBody tr').each(function () {
                const rowText = $(this).text().toLowerCase();
                $(this).toggle(rowText.includes(normalized));
            });
        }

        function populateEditModal(supplierId) {
            const supplier = supplierCache.get(supplierId);
            if (!supplier) {
                showAlert('danger', 'Supplier information could not be found in cache.');
                return;
            }

            $('#editSupplierId').val(supplier.shopId);
            $('#editShopName').val(supplier.shopName || '');
            $('#editPhone').val(supplier.phone || '');
            $('#editPassword').val(supplier.password || '');
            $('#editShopType').val(supplier.shopType || '');
            $('#editPriority').val(supplier.priority ?? '');
            $('#editVisibility').val(Number(supplier.isVisible) === 1 ? 'Visible' : 'Hidden');

            const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('editSupplierModal'));
            modal.show();
        }

        function togglePasswordVisibility() {
            const input = $('#editPassword');
            const icon = $('#togglePasswordBtn i');

            if (input.attr('type') === 'password') {
                input.attr('type', 'text');
                icon.removeClass('bi-eye').addClass('bi-eye-slash');
            } else {
                input.attr('type', 'password');
                icon.removeClass('bi-eye-slash').addClass('bi-eye');
            }
        }

        function submitEditForm(event) {
            event.preventDefault();
            const form = event.target;
            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                return;
            }
            form.classList.remove('was-validated');

            const payload = {
                shopId: Number($('#editSupplierId').val()),
                shopName: $('#editShopName').val().trim(),
                phone: $('#editPhone').val().trim(),
                password: $('#editPassword').val()
            };

            const spinner = $('#editFormSpinner');
            const submitText = $('#editFormSubmitText');
            spinner.removeClass('d-none');
            submitText.text('Saving…');

            $.ajax({
                url: '../api/updateSupplier.php',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(payload),
                dataType: 'json'
            }).done((response) => {
                if (response.success) {
                    showAlert('success', response.message || 'Supplier updated successfully.');
                    const modalElement = document.getElementById('editSupplierModal');
                    bootstrap.Modal.getInstance(modalElement)?.hide();
                    fetchSuppliers();
                } else {
                    showAlert('warning', response.message || 'No changes were made.');
                }
            }).fail((jqXHR) => {
                const message = jqXHR.responseJSON?.message || 'Server error while updating supplier.';
                showAlert('danger', message);
            }).always(() => {
                spinner.addClass('d-none');
                submitText.text('Save changes');
            });
        }

        function registerEventHandlers() {
            $('#supplierTableBody').on('click', '.btn-edit-supplier', function () {
                const supplierId = Number($(this).closest('tr').data('supplier-id'));
                if (Number.isInteger(supplierId)) {
                    populateEditModal(supplierId);
                }
            });

            $('#supplierSearch').on('input', function () {
                filterSuppliers($(this).val());
            });

            $('#refreshSuppliersBtn').on('click', () => fetchSuppliers());

            $('#togglePasswordBtn').on('click', togglePasswordVisibility);

            $('#editSupplierForm').on('submit', submitEditForm);
        }

        $(document).ready(() => {
            registerEventHandlers();
            fetchSuppliers();
        });
    })(jQuery);
</script>
</body>
</html>