<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Order Browser</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
        crossorigin="anonymous"
    >
    <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    >
    <style>
        body {
            background: linear-gradient(145deg, #f7f7ff 0%, #eef3fb 100%);
            min-height: 100vh;
        }

        .page-title {
            font-weight: 700;
            letter-spacing: 0.02em;
        }

        .list-group-item-action:hover,
        .list-group-item-action.active {
            background: linear-gradient(145deg, #3f51b5 0%, #6573d0 100%);
            color: #fff;
            transition: all 0.2s ease-in-out;
        }

        .status-pill {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }

        .empty-state {
            padding: 2.5rem 1rem;
            text-align: center;
            color: #6c757d;
        }

        .order-meta-label {
            font-weight: 600;
            color: #495057;
        }

        .order-meta-value {
            font-weight: 500;
            color: #212529;
        }

        .table thead th {
            border-top: none;
            background: #f5f7ff;
        }

        .refresh-button {
            border-radius: 999px;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg bg-white border-bottom shadow-sm">
    <div class="container">
        <span class="navbar-brand fw-semibold text-primary">
            <i class="bi bi-box-seam me-2"></i>
            Order Management
        </span>
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-outline-primary refresh-button" id="refreshOrdersBtn">
                <i class="bi bi-arrow-repeat me-1"></i>
                Refresh
            </button>
        </div>
    </div>
</nav>

<main class="container py-4">
    <div class="row g-4">
        <section class="col-lg-4">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white border-0 pb-0">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h2 class="h5 page-title mb-1">Orders</h2>
                            <p class="text-muted mb-0">Select an order to view its items</p>
                        </div>
                    </div>
                    <div class="mt-3">
                        <label for="orderSearch" class="form-label small text-uppercase text-muted mb-1">
                            <i class="bi bi-search me-1"></i>
                            Filter orders
                        </label>
                        <input type="search" class="form-control form-control-sm" id="orderSearch" placeholder="Search by customer, phone or order ID">
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="ordersContainer" class="list-group list-group-flush">
                        <div class="empty-state" id="ordersEmptyState">
                            <i class="bi bi-inboxes display-6 d-block mb-2"></i>
                            <p class="mb-0">No orders found yet.</p>
                            <small class="text-muted">Refresh to fetch the latest orders.</small>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <section class="col-lg-8">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white border-0 d-flex align-items-start justify-content-between">
                    <div>
                        <h2 class="h5 page-title mb-1" id="orderDetailsTitle">Order Details</h2>
                        <p class="text-muted mb-0" id="orderDetailsSubtitle">
                            Select an order to see its ordered items, supplier info and amounts.
                        </p>
                    </div>
                    <span class="badge bg-secondary status-pill align-self-center" id="orderStatusPill">Idle</span>
                </div>
                <div class="card-body">
                    <div id="orderMeta" class="mb-4">
                        <div class="row gy-3">
                            <div class="col-md-6">
                                <div class="d-flex flex-column">
                                    <span class="order-meta-label">Customer</span>
                                    <span class="order-meta-value" id="orderCustomer">—</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex flex-column">
                                    <span class="order-meta-label">Contact</span>
                                    <span class="order-meta-value" id="orderPhone">—</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex flex-column">
                                    <span class="order-meta-label">Ordered on</span>
                                    <span class="order-meta-value" id="orderPlacedAt">—</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex flex-column">
                                    <span class="order-meta-label">Totals</span>
                                    <span class="order-meta-value" id="orderTotals">—</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive border rounded">
                        <table class="table table-hover mb-0">
                            <thead>
                            <tr>
                                <th scope="col">Item</th>
                                <th scope="col" class="text-center">Qty</th>
                                <th scope="col" class="text-end">Unit Price</th>
                                <th scope="col" class="text-end">Line Total</th>
                                <th scope="col">Supplier</th>
                                <th scope="col" class="text-center">Credit</th>
                            </tr>
                            </thead>
                            <tbody id="orderItemsBody">
                            <tr>
                                <td colspan="6" class="text-center py-4 text-muted" id="orderItemsEmpty">
                                    Select an order to load its items.
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer bg-white border-0 d-flex justify-content-between align-items-center">
                    <small class="text-muted" id="orderMetaSummary">Awaiting selection.</small>
                    <div>
                        <span class="badge bg-light text-dark">
                            <i class="bi bi-box2-heart me-1"></i>
                            Items: <span id="orderItemCount">0</span>
                        </span>
                        <span class="badge bg-light text-dark ms-2">
                            <i class="bi bi-stack me-1"></i>
                            Total quantity: <span id="orderTotalQuantity">0</span>
                        </span>
                    </div>
                </div>
            </div>
        </section>
    </div>
</main>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-3fu41g6CIfb0PuOYw35vjU/9r6pU5r3yS2e1C5k0z4I="
        crossorigin="anonymous"></script>
<script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
    crossorigin="anonymous"
></script>
<script>
    (function ($) {
        'use strict';

        const ordersCache = new Map();
        const statusMap = new Map([
            [1, {label: 'Ordered', className: 'bg-info'}],
            [2, {label: 'Fast', className: 'bg-primary'}],
            [3, {label: 'Pick-up', className: 'bg-warning text-dark'}],
            [4, {label: 'Prepared', className: 'bg-secondary'}],
            [5, {label: 'Shipped', className: 'bg-warning text-dark'}],
            [6, {label: 'Delivered', className: 'bg-success'}],
            [7, {label: 'Cancelled', className: 'bg-danger'}],
            [8, {label: 'Checked', className: 'bg-dark'}],
            [9, {label: 'Mixed', className: 'bg-purple'}]
        ]);

        const currencyFormatter = new Intl.NumberFormat(undefined, {
            style: 'currency',
            currency: 'ETB',
            minimumFractionDigits: 2
        });

        function formatDateTime(isoString) {
            if (!isoString) {
                return '—';
            }
            const date = new Date(isoString);
            if (Number.isNaN(date.getTime())) {
                return isoString;
            }
            return date.toLocaleString();
        }

        function updateStatusPill(deliverStatus) {
            const pill = $('#orderStatusPill');
            const statusInfo = statusMap.get(deliverStatus);
            pill.removeClass().addClass('badge status-pill');
            if (statusInfo) {
                pill.addClass(statusInfo.className);
                pill.text(statusInfo.label);
            } else {
                pill.addClass('bg-secondary');
                pill.text('Unknown');
            }
        }

        function renderOrders(orders) {
            const container = $('#ordersContainer');
            const emptyState = $('#ordersEmptyState');

            container.empty();
            ordersCache.clear();

            if (!Array.isArray(orders) || orders.length === 0) {
                container.append(emptyState);
                emptyState.show();
                return;
            }

            emptyState.hide();

            orders.forEach((order, index) => {
                ordersCache.set(order.orderId, order);
                const item = $(`
                    <button type="button"
                            class="list-group-item list-group-item-action d-flex justify-content-between align-items-start"
                            data-order-id="${order.orderId}">
                        <div class="me-3">
                            <div class="fw-semibold">Order #${order.orderId}</div>
                            <small class="text-muted d-block">${order.customerName || 'Unknown customer'}</small>
                            <small class="text-muted d-block">${formatDateTime(order.orderTime)}</small>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-light text-dark mb-1">
                                <i class="bi bi-stack me-1"></i>${order.itemCount}
                            </span>
                            <div class="fw-semibold">${currencyFormatter.format(order.totalPrice || 0)}</div>
                        </div>
                    </button>
                `);
                container.append(item);
                if (index === 0) {
                    item.addClass('active');
                    selectOrder(order.orderId);
                }
            });
        }

        function renderOrderItems(orderId, items) {
            const tbody = $('#orderItemsBody');
            tbody.empty();

            if (!Array.isArray(items) || items.length === 0) {
                tbody.append(`
                    <tr>
                        <td colspan="6" class="text-center py-4 text-muted">No items found for this order.</td>
                    </tr>
                `);
                $('#orderItemCount').text('0');
                $('#orderTotalQuantity').text('0');
                $('#orderMetaSummary').text(`Order #${orderId} has no recorded items.`);
                return;
            }

            let totalQuantity = 0;
            items.forEach((item) => {
                const quantity = item.quantity ?? 0;
                const unitPrice = item.unitPrice ?? 0;
                const lineTotal = quantity * unitPrice;

                totalQuantity += quantity;

                const row = $(`
                    <tr>
                        <td>
                            <div class="fw-semibold">${item.goodsName || 'Unnamed item'}</div>
                            <small class="text-muted">${item.goodsImage ? item.goodsImage : ''}</small>
                        </td>
                        <td class="text-center">${quantity}</td>
                        <td class="text-end">${currencyFormatter.format(unitPrice)}</td>
                        <td class="text-end">${currencyFormatter.format(lineTotal)}</td>
                        <td>${item.supplierName || '—'}</td>
                        <td class="text-center">
                            ${item.eligibleForCredit ? '<span class="badge bg-success">Yes</span>' : '<span class="badge bg-secondary">No</span>'}
                        </td>
                    </tr>
                `);
                tbody.append(row);
            });

            $('#orderItemCount').text(items.length);
            $('#orderTotalQuantity').text(totalQuantity);
            $('#orderMetaSummary').text(`Order #${orderId} contains ${items.length} item(s) with a total quantity of ${totalQuantity}.`);
        }

        function selectOrder(orderId) {
            const order = ordersCache.get(orderId);
            if (!order) {
                return;
            }

            $('#ordersContainer .list-group-item').removeClass('active');
            $(`#ordersContainer .list-group-item[data-order-id="${orderId}"]`).addClass('active');

            $('#orderDetailsTitle').text(`Order #${orderId}`);
            $('#orderDetailsSubtitle').text(order.comment ? order.comment : 'Ordered items and supplier details.');
            $('#orderCustomer').text(order.customerName || '—');
            $('#orderPhone').text(order.customerPhone || '—');
            $('#orderPlacedAt').text(formatDateTime(order.orderTime));
            $('#orderTotals').text(
                `${currencyFormatter.format(order.totalPrice || 0)} • Profit: ${currencyFormatter.format(order.profit || 0)}`
            );
            updateStatusPill(order.deliverStatus);

            $.ajax({
                url: '../api/getOrderList.php',
                method: 'GET',
                data: {orderId},
                dataType: 'json',
                beforeSend() {
                    $('#orderItemsBody').html(`
                        <tr>
                            <td colspan="6" class="text-center py-4 text-muted">
                                <div class="spinner-border spinner-border-sm me-2 text-primary"></div>
                                Loading order items…
                            </td>
                        </tr>
                    `);
                }
            }).done((response) => {
                if (response.success) {
                    renderOrderItems(orderId, response.items);
                } else {
                    renderOrderItems(orderId, []);
                    $('#orderMetaSummary').text(response.message || 'Failed to load order items.');
                }
            }).fail(() => {
                renderOrderItems(orderId, []);
                $('#orderMetaSummary').text('Unable to load order items. Please try again.');
            });
        }

        function loadOrders() {
            $.ajax({
                url: '../api/getOrder.php',
                method: 'GET',
                dataType: 'json',
                beforeSend() {
                    $('#ordersContainer').html(`
                        <div class="empty-state">
                            <div class="spinner-border text-primary mb-3"></div>
                            <p class="mb-0">Fetching orders…</p>
                            <small class="text-muted">Please wait a moment.</small>
                        </div>
                    `);
                }
            }).done((response) => {
                if (response.success) {
                    renderOrders(response.orders);
                } else {
                    $('#ordersContainer').html(`
                        <div class="empty-state">
                            <i class="bi bi-exclamation-circle display-6 d-block mb-3 text-danger"></i>
                            <p class="mb-0">${response.message || 'Failed to load orders.'}</p>
                        </div>
                    `);
                }
            }).fail(() => {
                $('#ordersContainer').html(`
                    <div class="empty-state">
                        <i class="bi bi-wifi-off display-6 d-block mb-3 text-danger"></i>
                        <p class="mb-0">Unable to reach the server.</p>
                        <small class="text-muted">Check your connection and retry.</small>
                    </div>
                `);
            });
        }

        function attachEventHandlers() {
            $('#ordersContainer').on('click', '.list-group-item', function () {
                const orderId = Number($(this).data('order-id'));
                if (Number.isInteger(orderId)) {
                    selectOrder(orderId);
                }
            });

            $('#refreshOrdersBtn').on('click', () => {
                loadOrders();
            });

            $('#orderSearch').on('input', function () {
                const query = $(this).val().trim().toLowerCase();
                $('#ordersContainer .list-group-item').each(function () {
                    const text = $(this).text().toLowerCase();
                    $(this).toggle(text.includes(query));
                });
            });
        }

        $(document).ready(() => {
            attachEventHandlers();
            loadOrders();
        });
    })(jQuery);
</script>
</body>
</html>